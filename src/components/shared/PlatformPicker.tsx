import BottomSheet from './BottomSheet'
import { STREAMING_PLATFORMS, type OdesliResponse } from '../../api/feed'

interface PlatformPickerProps {
  isOpen: boolean
  onClose: () => void
  odesliData: OdesliResponse | null
  loading?: boolean
  title?: string
  mode?: 'mobile' | 'desktop'
  position?: { x: number; y: number }
  zIndex?: number
}

// Platform icons as simple components (using text/emoji as fallback since we don't have brand icons)
const platformIcons: Record<string, React.ReactNode> = {
  spotify: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
    </svg>
  ),
  appleMusic: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.106 1.596-.35 2.296-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.045-1.773-.6-1.943-1.536a1.88 1.88 0 011.038-2.022c.323-.16.67-.25 1.018-.324.378-.082.758-.153 1.134-.24.274-.063.457-.23.51-.516a.904.904 0 00.02-.193c0-1.815 0-3.63-.002-5.443a.725.725 0 00-.026-.185c-.04-.15-.15-.243-.304-.234-.16.01-.318.035-.475.066-.76.15-1.52.303-2.28.456l-2.326.47-1.374.278c-.016.003-.032.01-.048.013-.277.077-.377.203-.39.49-.002.042 0 .086 0 .13-.002 2.602 0 5.204-.003 7.805 0 .42-.047.836-.215 1.227-.278.64-.77 1.04-1.434 1.233-.35.1-.71.16-1.075.172-.96.036-1.755-.6-1.92-1.544-.14-.812.23-1.685 1.154-2.075.357-.15.73-.232 1.108-.31.287-.06.575-.116.86-.177.383-.083.583-.323.6-.714v-.15c0-2.96 0-5.922.002-8.883 0-.123.013-.25.042-.37.07-.285.273-.448.546-.518.255-.065.515-.112.774-.165.733-.15 1.466-.296 2.2-.444l2.27-.46c.67-.134 1.34-.27 2.01-.403.22-.043.443-.088.664-.106.31-.025.523.17.554.482.008.073.012.148.012.223.002 1.91.002 3.822 0 5.732z"/>
    </svg>
  ),
  youtube: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M23.498 6.186a3.016 3.016 0 00-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 00.502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 002.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 002.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
    </svg>
  ),
  youtubeMusic: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M12 0C5.376 0 0 5.376 0 12s5.376 12 12 12 12-5.376 12-12S18.624 0 12 0zm0 19.104c-3.924 0-7.104-3.18-7.104-7.104S8.076 4.896 12 4.896s7.104 3.18 7.104 7.104-3.18 7.104-7.104 7.104zm0-13.332c-3.432 0-6.228 2.796-6.228 6.228S8.568 18.228 12 18.228s6.228-2.796 6.228-6.228S15.432 5.772 12 5.772zM9.684 15.54V8.46L15.816 12l-6.132 3.54z"/>
    </svg>
  ),
  tidal: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M12.012 3.992L8.008 7.996 4.004 3.992 0 7.996 4.004 12l4.004-4.004L12.012 12l4.004-4.004L20.02 12l4.004-4.004-4.004-4.004-4.004 4.004-4.004-4.004zM12.012 12.012L8.008 16.02l4.004 4.004 4.004-4.004-4.004-4.008z"/>
    </svg>
  ),
  deezer: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M18.81 4.16v3.03H24V4.16h-5.19zM6.27 8.38v3.027h5.189V8.38h-5.19zm12.54 0v3.027H24V8.38h-5.19zM6.27 12.594v3.027h5.189v-3.027h-5.19zm6.27 0v3.027h5.19v-3.027h-5.19zm6.27 0v3.027H24v-3.027h-5.19zM0 16.81v3.029h5.19v-3.03H0zm6.27 0v3.029h5.189v-3.03h-5.19zm6.27 0v3.029h5.19v-3.03h-5.19zm6.27 0v3.029H24v-3.03h-5.19z"/>
    </svg>
  ),
  amazonMusic: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M.045 18.02c.072-.116.187-.124.348-.022 3.636 2.11 7.594 3.166 11.87 3.166 2.852 0 5.668-.533 8.447-1.595l.315-.118c.138-.053.209-.073.315-.073.186 0 .27.089.27.267 0 .178-.089.355-.267.533l-.178.178c-2.852 2.346-6.22 3.52-10.106 3.52-4.24 0-7.942-1.192-11.107-3.574-.168-.133-.217-.244-.217-.333 0-.089.044-.133.133-.178zm21.243-3.928c-.236-.178-.712-.267-1.424-.267-.712 0-1.598.178-2.665.533-1.067.356-2.134.89-3.201 1.602-.178.089-.267.178-.267.267s.089.133.267.133c.089 0 .178-.044.267-.089l.356-.178c1.156-.533 2.223-.8 3.2-.8.979 0 1.469.267 1.469.8 0 .356-.178.712-.534 1.068-.356.355-.89.711-1.6 1.066l-.535.267c-.356.178-.534.356-.534.534 0 .133.089.2.267.2.089 0 .178-.022.267-.067l.445-.222c1.6-.8 2.756-1.424 3.467-1.869.712-.444 1.068-.889 1.068-1.333 0-.445-.178-.712-.534-.978-.356-.267-.978-.4-1.868-.4zm-6.844-7.11c0-1.067-.267-1.957-.8-2.67-.533-.711-1.422-1.066-2.666-1.066-1.244 0-2.223.355-2.933 1.066-.712.712-1.156 1.78-1.334 3.2h7.733v-.533zm3.911 1.956H8.045c.089 1.422.445 2.489 1.067 3.2.622.712 1.511 1.067 2.666 1.067.89 0 1.69-.178 2.4-.533.712-.356 1.334-.89 1.868-1.6.178-.178.356-.267.534-.267.178 0 .267.089.267.267 0 .178-.089.356-.267.533-.622.8-1.422 1.423-2.4 1.868-.978.445-2.044.667-3.2.667-1.778 0-3.2-.533-4.267-1.6-1.067-1.066-1.6-2.577-1.6-4.533 0-1.956.533-3.467 1.6-4.533 1.067-1.067 2.489-1.6 4.267-1.6 1.778 0 3.111.445 4 1.334.89.889 1.334 2.177 1.334 3.866v1.067c0 .266-.089.4-.267.4l-.089-.003z"/>
    </svg>
  ),
  soundcloud: (
    <svg viewBox="0 0 24 24" className="w-5 h-5" fill="currentColor">
      <path d="M1.175 12.225c-.051 0-.094.046-.101.1l-.233 2.154.233 2.105c.007.058.05.098.101.098.05 0 .09-.04.099-.098l.255-2.105-.27-2.154c-.009-.06-.048-.1-.098-.1m-.899.828c-.06 0-.091.037-.104.094L0 14.479l.165 1.308c.014.057.045.094.09.094s.089-.037.099-.094l.19-1.308-.19-1.334c-.01-.057-.045-.09-.09-.09m1.83-1.229c-.061 0-.12.045-.12.104l-.21 2.563.225 2.458c0 .06.045.104.106.104.061 0 .12-.044.12-.104l.24-2.458-.24-2.563c0-.06-.045-.104-.12-.104m.945-.089c-.075 0-.135.06-.15.135l-.193 2.64.21 2.544c.016.077.075.138.149.138.075 0 .135-.061.15-.138l.225-2.545-.225-2.64c-.015-.074-.06-.135-.135-.135m1.065.42c-.09 0-.149.075-.164.164l-.158 2.255.18 2.46c.015.09.074.165.164.165.089 0 .149-.075.164-.165l.209-2.46-.209-2.255c-.015-.09-.075-.164-.164-.164m.944-.54c-.104 0-.194.09-.209.195l-.149 2.81.164 2.445c.015.105.09.195.194.195.104 0 .195-.09.21-.195l.18-2.445-.18-2.81c-.015-.105-.09-.195-.194-.195m1.076-.505c-.119 0-.21.09-.225.21l-.135 3.3.149 2.4c.015.12.105.21.225.21.12 0 .21-.09.225-.21l.165-2.4-.165-3.3c-.015-.12-.105-.21-.225-.21m1.064-.54c-.135 0-.239.105-.254.24l-.12 3.825.135 2.354c.015.135.12.24.255.24.12 0 .24-.105.255-.24l.149-2.354-.149-3.825c-.015-.135-.12-.24-.255-.24m1.109-.27c-.015-.15-.135-.255-.27-.255-.15 0-.255.105-.27.255l-.12 4.08.12 2.31c.015.15.12.255.27.255.149 0 .255-.105.27-.255l.134-2.31-.134-4.08m.494 6.645c.015.165.135.284.285.284.149 0 .27-.12.284-.284l.121-2.325-.12-5.175c-.015-.165-.135-.285-.285-.285-.149 0-.27.12-.284.285l-.107 5.175.106 2.325m1.184-6.18c-.165 0-.3.135-.314.3l-.091 3.855.105 2.31c.015.165.135.3.3.3.164 0 .284-.135.299-.3l.12-2.31-.12-3.855c-.015-.165-.135-.3-.3-.3m1.199-.075c-.18 0-.314.135-.329.315l-.09 3.915.104 2.295c.015.18.135.315.315.315s.314-.135.314-.315l.12-2.295-.12-3.915c-.015-.18-.149-.315-.314-.315m1.139-.195c-.195 0-.345.149-.359.345l-.075 4.11.09 2.265c.014.195.149.345.344.345.195 0 .345-.15.359-.345l.105-2.265-.105-4.095c-.014-.195-.164-.36-.359-.36m1.305 0c-.209 0-.359.164-.374.359l-.074 4.095.089 2.25c.015.21.165.375.375.375.194 0 .359-.165.374-.375l.09-2.25-.09-4.095c-.015-.209-.165-.359-.375-.359m1.289.015c-.225 0-.39.18-.39.405l-.06 4.065.075 2.235c.016.225.166.39.391.39.225 0 .391-.165.406-.39l.09-2.235-.091-4.065c-.014-.24-.18-.405-.405-.405m1.35.09c-.24 0-.42.18-.42.42l-.045 3.975.06 2.205c.015.24.18.42.42.42.24 0 .404-.18.42-.42l.075-2.205-.075-3.975c-.015-.24-.18-.42-.42-.42m1.33.135c-.256 0-.435.194-.45.435l-.046 3.825.061 2.175c.015.255.195.45.435.45.256 0 .436-.195.45-.45l.076-2.175-.076-3.825c-.014-.255-.194-.435-.45-.435m1.453-.09c-.27 0-.48.21-.48.465l-.03 3.915.03 2.145c.015.27.21.465.48.465.27 0 .48-.195.48-.465l.045-2.145-.045-3.915c0-.255-.21-.465-.48-.465m1.444.285c-.285 0-.495.225-.51.495l-.015 3.645.03 2.13c.015.285.225.51.51.51.27 0 .494-.225.51-.51l.03-2.13-.03-3.645c-.016-.285-.225-.495-.51-.495m3.39.465c-.165-.045-.345-.075-.51-.075-.18 0-.345.015-.51.045-.044-.9-.39-1.695-.945-2.34-.556-.645-1.35-1.08-2.31-1.215-.27-.045-.405-.165-.405-.405V6.54c0-1.305-.465-2.415-1.395-3.345C19.2 2.265 18.09 1.8 16.77 1.8c-1.155 0-2.16.375-3.045 1.095-.885.72-1.44 1.635-1.68 2.745-.165-.03-.315-.045-.45-.045-1.35 0-2.355.93-2.355 2.115 0 .24.03.465.075.69-.645.12-1.17.435-1.59.945-.42.51-.63 1.095-.63 1.755 0 .75.255 1.38.765 1.89s1.14.765 1.89.765h10.53c.93 0 1.695-.285 2.31-.855.615-.57.93-1.29.93-2.145 0-.855-.3-1.575-.9-2.16-.6-.585-1.335-.885-2.205-.9"/>
    </svg>
  ),
}

function PlatformSkeleton() {
  return (
    <div className="animate-pulse space-y-0">
      {[...Array(4)].map((_, i) => (
        <div key={i} className="flex items-center gap-3 px-4 py-2.5">
          <div className="w-5 h-5 rounded bg-zinc-700" />
          <div className="h-4 bg-zinc-700 rounded w-24" />
        </div>
      ))}
    </div>
  )
}

export default function PlatformPicker({
  isOpen,
  onClose,
  odesliData,
  loading = false,
  title: propTitle,
  mode = 'mobile',
  position,
  zIndex = 99999
}: PlatformPickerProps) {
  if (!isOpen) {
    return null
  }

  // Get available platforms from Odesli data
  const availablePlatforms = odesliData
    ? STREAMING_PLATFORMS.filter(platform => odesliData.linksByPlatform[platform.id])
    : []

  const handlePlatformClick = (platformId: string) => {
    if (!odesliData) return
    const platformData = odesliData.linksByPlatform[platformId]
    if (platformData?.url) {
      window.open(platformData.url, '_blank', 'noopener,noreferrer')
    }
    onClose()
  }

  // Get title from Odesli data or prop
  const getTitle = () => {
    if (propTitle) return propTitle
    if (!odesliData?.entitiesByUniqueId) return 'Loading...'
    const entities = Object.values(odesliData.entitiesByUniqueId)
    for (const entity of entities) {
      if (entity.title) {
        return entity.title
      }
    }
    return 'Loading...'
  }

  const title = getTitle()
  const showSkeleton = loading || !odesliData || availablePlatforms.length === 0

  // Desktop mode - floating menu
  if (mode === 'desktop') {
    const menuWidth = 220
    const itemCount = showSkeleton ? 4 : availablePlatforms.length
    const menuHeight = Math.min(400, itemCount * 44 + 48)

    let menuX = position?.x || 100
    let menuY = position?.y || 100

    if (menuX + menuWidth > window.innerWidth) {
      menuX = window.innerWidth - menuWidth - 10
    }
    if (menuY + menuHeight > window.innerHeight) {
      menuY = window.innerHeight - menuHeight - 10
    }

    return (
      <>
        <div
          className="fixed inset-0"
          onClick={onClose}
          style={{ zIndex: zIndex - 1 }}
        />
        <div
          className="fixed bg-zinc-900 border border-zinc-700 rounded-lg shadow-2xl py-2 min-w-[200px]"
          style={{
            left: menuX,
            top: menuY,
            zIndex
          }}
          onClick={(e) => e.stopPropagation()}
        >
          <div className="px-4 pb-2 mb-1 border-b border-zinc-700">
            <div className="text-sm font-medium text-white truncate">{title}</div>
          </div>
          {showSkeleton ? (
            <PlatformSkeleton />
          ) : (
            <div className="space-y-0">
              {availablePlatforms.map((platform) => (
                <button
                  key={platform.id}
                  onClick={() => handlePlatformClick(platform.id)}
                  className="w-full flex items-center gap-3 px-4 py-2.5 hover:bg-zinc-800 transition-colors text-left"
                >
                  <span className="text-white flex-shrink-0">
                    {platformIcons[platform.id] || <span className="w-5 h-5 flex items-center justify-center text-xs">ðŸŽµ</span>}
                  </span>
                  <span className="flex-1 text-sm text-white">{platform.name}</span>
                </button>
              ))}
            </div>
          )}
        </div>
      </>
    )
  }

  // Mobile mode - bottom sheet
  return (
    <BottomSheet isOpen={isOpen} onClose={onClose} zIndex={zIndex}>
      <div className="pb-6">
        <div className="mb-4 ml-4">
          <div className="text-lg font-semibold text-white break-words">{title}</div>
        </div>

        {showSkeleton ? (
          <div className="animate-pulse space-y-1">
            {[...Array(4)].map((_, i) => (
              <div key={i} className="flex items-center gap-4 pl-4 pr-4 py-3">
                <div className="w-5 h-5 rounded bg-zinc-700" />
                <div className="h-4 bg-zinc-700 rounded w-28" />
              </div>
            ))}
          </div>
        ) : (
          <div className="space-y-1">
            {availablePlatforms.map((platform) => (
              <button
                key={platform.id}
                onClick={() => handlePlatformClick(platform.id)}
                className="w-full flex items-center gap-4 pl-4 pr-4 py-3 rounded-lg hover:bg-white/10 transition-colors"
              >
                <span className="text-white">
                  {platformIcons[platform.id] || <span className="w-5 h-5 flex items-center justify-center text-xs">ðŸŽµ</span>}
                </span>
                <span className="flex-1 text-left text-white font-medium">{platform.name}</span>
              </button>
            ))}
          </div>
        )}
      </div>
    </BottomSheet>
  )
}
