import{u as xe,a as ge,r as n,b as ze,e as P,j as e,d as He,h as Ye,G as _e,P as $e,L as Ue,C as Be,f as q,D as ye,U as pe}from"./index-AOm-apGX.js";import{u as Ve,f as Qe,S as We}from"./search-tT2_0xD9.js";import{S as Xe}from"./SongItem-D7ZDpzy7.js";import{P as Je}from"./Pagination-DWlypBkE.js";import{F as be}from"./FilterBottomSheet-j5wc8c6N.js";import{A as qe}from"./arrow-up-down-CX2ufI1q.js";import{C as Ke}from"./calendar-B3NUgHI7.js";const J=new Map;function Ze({artist:s,onClick:C,onContextMenu:N,contextMenuItemId:M}){var a;const[T,p]=n.useState(!1),u=n.useRef(!1),A=M===s.Id,[w,S]=n.useState(null);n.useEffect(()=>{var L;if((L=s.ImageTags)!=null&&L.Primary){S(null);return}const i=J.get(s.Id);if(i!==void 0){S(i);return}let r=!1;return(async()=>{try{const{albums:k,songs:z}=await P.getArtistItems(s.Id),$=k[0],U=z.find(B=>B.AlbumId)||z[0],R=$||U,d=R?R.AlbumId||R.Id:null,F=d?P.getAlbumArtUrl(d,96):null;J.set(s.Id,F),r||S(F)}catch(k){console.error("Failed to load fallback album art for artist (search item):",s.Id,k),J.set(s.Id,null)}})(),()=>{r=!0}},[s.Id,s.ImageTags]);const j=i=>{if(A||u.current){i.preventDefault(),i.stopPropagation(),u.current=!1;return}C(s.Id)},c=i=>{i.preventDefault(),i.stopPropagation(),u.current=!0,N(s,"artist","desktop",{x:i.clientX,y:i.clientY}),setTimeout(()=>{u.current=!1},300)},x=q({onLongPress:i=>{i.preventDefault(),u.current=!0,N(s,"artist","mobile")},onClick:j});return e.jsxs("button",{onClick:j,onContextMenu:c,...x,className:`w-full flex items-center gap-4 hover:bg-white/10 transition-colors text-left cursor-pointer px-4 h-[72px] ${A?"bg-white/10":""}`,children:[e.jsx("div",{className:"w-12 h-12 rounded-full overflow-hidden flex-shrink-0 bg-zinc-900 flex items-center justify-center",children:T?e.jsx(pe,{className:"w-6 h-6 text-gray-500"}):w||(a=s.ImageTags)!=null&&a.Primary?e.jsx("img",{src:w||P.getArtistImageUrl(s.Id,96),alt:s.Name,className:"w-full h-full object-cover",onError:()=>p(!0),loading:"lazy"}):e.jsx(pe,{className:"w-6 h-6 text-gray-500"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("div",{className:"text-base font-medium text-white truncate group-hover:text-[var(--accent-color)] transition-colors",children:s.Name})})]})}function et({album:s,onClick:C,onContextMenu:N,contextMenuItemId:M}){var c,x;const[T,p]=n.useState(!1),u=n.useRef(!1),A=M===s.Id,w=a=>{if(A||u.current){a.preventDefault(),a.stopPropagation(),u.current=!1;return}C(s.Id)},S=a=>{a.preventDefault(),a.stopPropagation(),u.current=!0,N(s,"album","desktop",{x:a.clientX,y:a.clientY}),setTimeout(()=>{u.current=!1},300)},j=q({onLongPress:a=>{a.preventDefault(),u.current=!0,N(s,"album","mobile")},onClick:w});return e.jsxs("button",{onClick:w,onContextMenu:S,...j,className:"text-left group",children:[e.jsx("div",{className:"aspect-square rounded overflow-hidden mb-3 bg-zinc-900 shadow-lg relative flex items-center justify-center",children:T?e.jsx(ye,{className:"w-12 h-12 text-gray-500"}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:P.getAlbumArtUrl(s.Id,474),alt:s.Name,className:"w-full h-full object-cover",onError:()=>p(!0)}),e.jsx("div",{className:"absolute inset-0 pointer-events-none border border-white rounded",style:{borderColor:"rgba(255, 255, 255, 0.03)",borderWidth:"1px"}})]})}),e.jsx("div",{className:"text-sm font-semibold text-white truncate mb-1",children:s.Name}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:s.AlbumArtist||((x=(c=s.ArtistItems)==null?void 0:c[0])==null?void 0:x.Name)||"Unknown Artist"})]})}function tt({song:s,onClick:C,onContextMenu:N,contextMenuItemId:M,showImage:T=!0}){var a,i;const p=n.useRef(!1),u=M===s.Id,[A,w]=n.useState(!1),S=r=>{const b=Math.floor(r/1e7),L=Math.floor(b/60),k=b%60;return`${L}:${k.toString().padStart(2,"0")}`},j=r=>{if(u||p.current){r.preventDefault(),r.stopPropagation(),p.current=!1;return}C(s)},c=r=>{r.preventDefault(),r.stopPropagation(),p.current=!0,N(s,"song","desktop",{x:r.clientX,y:r.clientY}),setTimeout(()=>{p.current=!1},300)},x=q({onLongPress:r=>{r.preventDefault(),p.current=!0,N(s,"song","mobile")},onClick:j});return e.jsxs("button",{onClick:j,onContextMenu:c,...x,className:`w-full flex items-center gap-3 hover:bg-white/10 transition-colors group px-4 py-3 ${u?"bg-white/10":""}`,children:[e.jsx("div",{className:"w-12 h-12 rounded-sm overflow-hidden flex-shrink-0 bg-zinc-900 self-center relative flex items-center justify-center",children:A?e.jsx(ye,{className:"w-7 h-7 text-gray-500"}):e.jsxs(e.Fragment,{children:[e.jsx("img",{src:P.getAlbumArtUrl(s.AlbumId||s.Id,96),alt:s.Name,className:"w-full h-full object-cover",loading:"lazy",onError:()=>w(!0)}),e.jsx("div",{className:"absolute inset-0 pointer-events-none border border-white rounded-sm",style:{borderColor:"rgba(255, 255, 255, 0.03)",borderWidth:"1px"}})]})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left",children:[e.jsx("div",{className:"text-sm font-medium text-white truncate group-hover:text-[var(--accent-color)] transition-colors",children:s.Name}),e.jsxs("div",{className:"text-xs text-gray-400 truncate",children:[s.AlbumArtist||((i=(a=s.ArtistItems)==null?void 0:a[0])==null?void 0:i.Name)||"Unknown Artist",s.Album&&` â€¢ ${s.Album}`]})]}),s.RunTimeTicks&&e.jsx("div",{className:"text-xs text-gray-500 flex-shrink-0 text-right",children:S(s.RunTimeTicks)})]})}const _=90,ve=45,st=45,je=45,nt=45;function dt(){const{songs:s,setSongs:C,sortPreferences:N,setSortPreference:M,setLoading:T,loading:p,genres:u}=xe(),{playTrack:A,playAlbum:w,addToQueue:S}=ge(),j=ge(t=>t.isQueueSidebarOpen),[c,x]=n.useState(""),[a,i]=n.useState(!1),[r,b]=n.useState(null),[L,k]=n.useState(!1),[z,$]=n.useState("mobile"),[U,R]=n.useState(null),[d,F]=n.useState(null),[B,K]=n.useState(null),[Ne,V]=n.useState(!1),v=n.useRef(null),[H,Z]=n.useState(0),[ee,te]=n.useState(0),Q=ze(),G=n.useRef(null),se=n.useRef(null),[I,ne]=n.useState([]),[m,re]=n.useState({min:null,max:null}),[le,W]=n.useState(!1),[ae,we]=n.useState(null),[Se,oe]=n.useState([]),E=N.songs,Y=n.useRef(!0),[Ie,ie]=n.useState(!1),ce=n.useRef(E),[Ce,ue]=n.useState(ve),[de,me]=n.useState(je);n.useEffect(()=>{(async()=>{try{const l=xe.getState();if(l.years.length>0)oe(l.years);else{const g=await P.getYears();oe(g)}}catch(l){console.error("Failed to load filter values:",l)}})()},[]);const fe=I.length>0||m.min!==null||m.max!==null;n.useEffect(()=>{v.current&&v.current.abort();const t=c.trim().length>0;if(t||fe){V(!0),v.current=new AbortController;const l=window.setTimeout(async()=>{var g,h,f,O;if(!((g=v.current)!=null&&g.signal.aborted))try{let y;t?y=await Ve(c,450):y=await Qe(450),(h=v.current)!=null&&h.signal.aborted||b(y)}catch(y){(f=v.current)!=null&&f.signal.aborted||(console.error("Search failed:",y),b(null))}finally{(O=v.current)!=null&&O.signal.aborted||V(!1)}},250);return()=>{window.clearTimeout(l),v.current&&v.current.abort()}}else v.current=null,b(null),V(!1)},[c,fe]);const o=n.useMemo(()=>{if(!r)return null;const t=h=>{if(m.min!==null||m.max!==null)return!1;if(I.length>0){const f=h.Genres||[];if(!I.some(y=>f.some(X=>X.toLowerCase()===y.toLowerCase())))return!1}return!0},l=h=>{if(I.length>0){const f=h.Genres||[];if(!I.some(y=>f.some(X=>X.toLowerCase()===y.toLowerCase())))return!1}if(m.min!==null||m.max!==null){const f=h.ProductionYear;if(!f||f<=0||m.min!==null&&f<m.min||m.max!==null&&f>m.max)return!1}return!0},g=h=>!(m.min!==null||m.max!==null||I.length>0);return{songs:r.songs.filter(l),artists:r.artists.filter(t),albums:r.albums.filter(l),playlists:(r.playlists||[]).filter(g)}},[r,I,m]);n.useEffect(()=>{var t;if(a&&((t=G.current)==null||t.focus(),G.current)){const l=G.current.value.length;G.current.setSelectionRange(l,l)}},[a]),n.useEffect(()=>()=>{v.current&&v.current.abort()},[]);const Ae=t=>{x(t),t.trim().length>0&&!a&&i(!0)},ke=()=>{x(""),b(null)},Ee=()=>{i(!1),x(""),b(null),ne([]),re({min:null,max:null})},he=t=>{we(t),W(!0)},Pe=t=>{ne(t)},Me=t=>{re(t)},Te=t=>{Q(`/artist/${t}`),i(!1),x(""),b(null)},Le=t=>{Q(`/album/${t}`),i(!1),x(""),b(null)},Oe=t=>{A(t,[t])},Re=t=>{t.preventDefault(),t.stopPropagation(),o!=null&&o.songs&&o.songs.length>0&&w(o.songs)},Fe=t=>{t.preventDefault(),t.stopPropagation(),o!=null&&o.songs&&o.songs.length>0&&S(o.songs)},Ge=t=>{Q(`/playlist/${t}`),i(!1),x(""),b(null)},D=(t,l,g="mobile",h)=>{F(t),K(l),$(g),R(h||null),k(!0)};n.useEffect(()=>{c.trim()||Z(0)},[E,c]),n.useEffect(()=>{me(je)},[c,a,r==null?void 0:r.songs.length]),n.useEffect(()=>{var g;const t=se.current;if(!a||!t||!((g=r==null?void 0:r.songs)!=null&&g.length))return;const l=()=>{const h=t.scrollTop,f=t.clientHeight,O=t.scrollHeight;h+f*1.5>=O&&me(y=>Math.min(y+nt,r.songs.length))};return t.addEventListener("scroll",l,{passive:!0}),()=>t.removeEventListener("scroll",l)},[a,r==null?void 0:r.songs.length,de]),n.useEffect(()=>{ue(ve)},[H,s.length]),n.useEffect(()=>{const t=()=>{const l=window.scrollY||document.documentElement.scrollTop,g=window.innerHeight||document.documentElement.clientHeight,h=document.documentElement.scrollHeight;l+g*1.5>=h&&ue(f=>Math.min(f+st,s.length))};return window.addEventListener("scroll",t,{passive:!0}),()=>window.removeEventListener("scroll",t)},[s.length]),n.useEffect(()=>{c.trim()||(!Y.current&&ce.current!==E&&ie(!0),ce.current=E,De())},[H,E,c]),n.useEffect(()=>{Y.current&&(Y.current=!1)},[]);const De=async()=>{T("songs",!0);try{const t={limit:_,startIndex:H*_};E==="RecentlyAdded"?(t.sortBy=["DateCreated"],t.sortOrder="Descending"):(t.sortBy=["SortName"],t.sortOrder="Ascending");const l=await P.getSongs(t);C(l.Items),te(l.TotalRecordCount||0)}catch(t){console.error("Failed to load songs:",t),C([]),te(0)}finally{T("songs",!1),ie(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"pb-20",children:[e.jsx("div",{className:`fixed top-0 left-0 right-0 bg-black z-10 lg:left-16 transition-[left,right] duration-300 ${j?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top))"},children:e.jsx("div",{className:"max-w-[768px] mx-auto",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Songs"}),e.jsx("button",{onClick:()=>i(!0),className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors","aria-label":"Search",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})})]}),!a&&e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("button",{onClick:()=>M("songs",E==="RecentlyAdded"?"Alphabetical":"RecentlyAdded"),className:"text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-1",children:[E==="RecentlyAdded"?"Recently Added":"Alphabetically",e.jsx(qe,{className:"w-4 h-4"})]}),p.songs&&!Y.current&&e.jsx("div",{className:"flex items-center",children:e.jsx(Ye,{})})]})]})})}),e.jsx("div",{className:`fixed left-0 right-0 z-10 lg:left-16 transition-[left,right] duration-300 ${j?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top) + 7rem - 8px)",height:"24px",background:"linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent)"}}),e.jsx("div",{style:{paddingTop:"calc(env(safe-area-inset-top) + 7rem)"},children:!a&&e.jsx("div",{className:Ie?"opacity-50 pointer-events-none":"",children:s.length===0&&!p.songs?e.jsx("div",{className:"flex items-center justify-center py-16 text-gray-400",children:e.jsx("p",{children:"No songs found"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"space-y-0",children:s.map((t,l)=>e.jsx(Xe,{song:t,showImage:l<Ce,onContextMenu:D,contextMenuItemId:(d==null?void 0:d.Id)||null},t.Id))}),e.jsx(Je,{currentPage:H,totalPages:Math.ceil(ee/_),onPageChange:Z,itemsPerPage:_,totalItems:ee})]})})})]}),a&&He.createPortal(e.jsx(e.Fragment,{children:e.jsxs("div",{ref:se,className:"fixed inset-0 bg-black z-[9999] overflow-y-auto p-0 m-0",children:[e.jsx("div",{className:"fixed top-0 left-0 right-0 bg-black z-50 pointer-events-none",style:{height:"env(safe-area-inset-top)",top:"var(--header-offset, 0px)"}}),e.jsx("div",{className:"fixed top-0 left-0 right-0 bg-black z-10 pt-0 pb-0 w-full m-0",style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top))",height:"76px"},children:e.jsx("div",{className:"max-w-[768px] mx-auto w-full",children:e.jsxs("div",{className:"flex items-center gap-3 px-4 pt-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(We,{ref:G,value:c,onChange:Ae,showClearButton:c.trim().length>0,onClear:ke})}),e.jsx("button",{onClick:Ee,className:"px-4 py-2 text-white text-sm font-medium hover:text-zinc-300 transition-colors whitespace-nowrap flex-shrink-0",children:"Cancel"})]})})}),e.jsxs("div",{className:"max-w-[768px] mx-auto w-full",style:{paddingTop:"calc(52px + env(safe-area-inset-top))"},children:[e.jsx("div",{className:"sticky bg-black z-10 pt-3 pb-4",style:{top:"calc(76px + env(safe-area-inset-top))"},children:e.jsxs("div",{className:"flex items-center gap-3 px-4",children:[e.jsxs("button",{onClick:()=>he("genre"),className:`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${I.length>0?"bg-[var(--accent-color)] text-white":"bg-white/10 text-white hover:bg-white/20"}`,"aria-label":"Filter by genre",children:[e.jsx(_e,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Genre"})]}),e.jsxs("button",{onClick:()=>he("year"),className:`flex items-center gap-2 px-3 py-2 rounded-lg transition-colors ${m.min!==null||m.max!==null?"bg-[var(--accent-color)] text-white":"bg-white/10 text-white hover:bg-white/20"}`,"aria-label":"Filter by year",children:[e.jsx(Ke,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"Year"})]})]})}),e.jsx("div",{className:`fixed left-0 right-0 z-[60] lg:left-16 transition-[left,right] duration-300 ${j?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top) + 76px + 4rem)",height:"24px",background:"linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent)"}}),e.jsx("div",{className:"pb-32",style:{paddingTop:"40px"},children:Ne?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-2 border-zinc-800 border-t-[var(--accent-color)]"})}):o?e.jsxs("div",{className:"space-y-8",children:[o.songs.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-4 px-4",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Songs"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:Re,className:"w-10 h-10 flex items-center justify-center text-white hover:bg-white/10 rounded-lg transition-colors","aria-label":"Play all songs",children:e.jsx($e,{className:"w-5 h-5"})}),e.jsx("button",{type:"button",onClick:Fe,className:"w-10 h-10 flex items-center justify-center text-white hover:bg-white/10 rounded-lg transition-colors","aria-label":"Add all songs to queue",children:e.jsx(Ue,{className:"w-5 h-5"})})]})]}),e.jsx("div",{className:"space-y-0",children:o.songs.map((t,l)=>e.jsx(tt,{song:t,onClick:Oe,onContextMenu:D,contextMenuItemId:(d==null?void 0:d.Id)||null,showImage:l<de},t.Id))})]}),o.artists.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4 px-4",children:"Artists"}),e.jsx("div",{className:"space-y-0",children:o.artists.slice(0,5).map(t=>e.jsx(Ze,{artist:t,onClick:Te,onContextMenu:D,contextMenuItemId:(d==null?void 0:d.Id)||null},t.Id))})]}),o.albums.length>0&&e.jsxs("div",{className:"px-4",children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4",children:"Albums"}),e.jsx("div",{className:"grid grid-cols-3 gap-4",children:o.albums.slice(0,12).map(t=>e.jsx(et,{album:t,onClick:Le,onContextMenu:D,contextMenuItemId:(d==null?void 0:d.Id)||null},t.Id))})]}),o.playlists&&o.playlists.length>0&&e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white mb-4 px-4",children:"Playlists"}),e.jsx("div",{className:"space-y-0",children:o.playlists.map(t=>e.jsxs("button",{onClick:()=>Ge(t.Id),onContextMenu:l=>{l.preventDefault(),l.stopPropagation(),D(t,"playlist","desktop",{x:l.clientX,y:l.clientY})},className:"w-full flex items-center gap-3 hover:bg-white/10 transition-colors group px-4 py-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-sm overflow-hidden flex-shrink-0 bg-zinc-900 self-center",children:e.jsx("img",{src:P.getAlbumArtUrl(t.Id,96),alt:t.Name,className:"w-full h-full object-cover",loading:"lazy"})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left",children:[e.jsx("div",{className:"text-sm font-medium text-white truncate group-hover:text-[var(--accent-color)] transition-colors",children:t.Name}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:t.ChildCount?`${t.ChildCount} tracks`:"Playlist"})]})]},t.Id))})]}),o.artists.length===0&&o.albums.length===0&&(!o.playlists||o.playlists.length===0)&&o.songs.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-16 text-gray-400 px-4",children:[e.jsx("div",{className:"text-lg mb-2",children:"No results found"}),e.jsx("div",{className:"text-sm",children:"Try a different search term"})]})]}):e.jsx("div",{className:"flex flex-col items-center justify-center py-16 text-gray-400 px-4"})})]})]})}),document.body),ae==="genre"&&e.jsx(be,{isOpen:le,onClose:()=>W(!1),filterType:"genre",genres:u,selectedValues:I,onApply:Pe}),ae==="year"&&e.jsx(be,{isOpen:le,onClose:()=>W(!1),filterType:"year",availableYears:Se,yearRange:m,onApplyYear:Me}),e.jsx(Be,{item:d,itemType:B,isOpen:L,onClose:()=>{k(!1),F(null),K(null)},zIndex:99999,mode:z,position:U||void 0})]})}export{dt as default};
