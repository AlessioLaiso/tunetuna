import{c as Fe,r as t,u as H,g as Ee,a as ie,b as Se,d as He,j as e,S as Ye,l as xe,e as L,I as Ae,C as we,f as Te,D as Ie,h as ve,i as _e,F as ye,k as We,m as Ve,P as Ue,n as Xe,o as Re,p as De,q as be,s as Qe,M as qe}from"./index-Def-zOqH.js";import{S as Je}from"./search-CX8aL8TO.js";import{u as Ke,F as je}from"./useSearch-D67U20TW.js";import{C as Ze,a as et}from"./chevron-right-CeVrquWf.js";import{E as tt}from"./ellipsis-CqmsnN94.js";import"./tag-Z6C-w5NC.js";import"./piano-GaLAw_6p.js";/**
 * @license lucide-react v0.560.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],nt=Fe("search",st);/**
 * @license lucide-react v0.560.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const lt=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],rt=Fe("settings",lt),at=[{type:"artists",limit:5},{type:"albums",limit:12},{type:"playlists"},{type:"songs"}];function it({onSearchStateChange:s,title:o="Search"}){const[r,l]=t.useState(!1),u=t.useRef(null),f=t.useRef(null),[y,a]=t.useState(!1),[c,n]=t.useState(null),[d,h]=t.useState(null),{genres:g,songs:m}=H(),[S,w]=t.useState([]),k=t.useMemo(()=>Ee(m),[m]),{playAlbum:O,addToQueue:T,playTrack:$,shuffleAllSongs:i,isQueueSidebarOpen:I}=ie(),[C,M]=t.useState(!1),{searchQuery:q,setSearchQuery:U,isSearching:oe,searchResults:F,selectedGenres:Z,setSelectedGenres:ee,yearRange:V,setYearRange:te,selectedGroupings:Q,setSelectedGroupings:se,groupingMatchModes:J,setGroupingMatchModes:X,clearSearch:_,clearAll:ce}=Ke({debounceMs:300});t.useEffect(()=>{if(C){const x=setTimeout(()=>{M(!1)},1e4);return()=>clearTimeout(x)}},[C]);const Y=Se(),[K,de]=He();t.useEffect(()=>{const x=K.get("yearMin"),N=K.get("yearMax"),E=K.get("genre");let W=!1;(x||N)&&(te({min:x?parseInt(x,10):null,max:N?parseInt(N,10):null}),W=!0),E&&(ee([E]),W=!0),W&&(l(!0),de({},{replace:!0}))},[]),t.useEffect(()=>{(async()=>{try{const N=H.getState();if(N.years.length>0)w(N.years);else{const E=await L.getYears();w(E)}}catch(N){xe.error("Failed to load filter values:",N)}})()},[]);const ue=x=>{U(x),x.trim().length>0&&!r&&l(!0)},v=x=>{Y(`/artist/${x}`),l(!1),_()},D=x=>{Y(`/album/${x}`),l(!1),_()},P=x=>{$(x,[x])},z=x=>{Y(`/playlist/${x}`),l(!1),_()},B=()=>{_()},p=()=>{l(!1),ce()},R=x=>{n(x),a(!0)},b=x=>{ee(x)},A=x=>{te(x)},j=x=>{h(x),n("grouping"),a(!0)},ne=(x,N)=>{se(E=>({...E,[x]:N}))},le=(x,N)=>{X(E=>({...E,[x]:N}))},he=()=>{F!=null&&F.songs&&F.songs.length>0&&O(F.songs)},pe=()=>{F!=null&&F.songs&&F.songs.length>0&&T(F.songs)},re=r;return t.useEffect(()=>{s&&s(re)},[re,s]),t.useEffect(()=>{if(r){const N=window.matchMedia("(hover: hover) and (pointer: fine) and (min-width: 1024px)").matches?f:u;setTimeout(()=>{var E;if((E=N.current)==null||E.focus(),N.current){const W=N.current.value.length;N.current.setSelectionRange(W,W)}},50)}},[r]),t.useEffect(()=>{if(!r)return;const x=N=>{N.key==="Escape"&&(N.preventDefault(),N.stopPropagation(),p())};return window.addEventListener("keydown",x,!0),()=>window.removeEventListener("keydown",x,!0)},[r]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-4 md:pl-2 md:pr-4 pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Tunetuna"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:async()=>{const x=ie.getState(),{isShuffleAllActive:N,isShuffleGenreActive:E}=x;if(!(C||N||E)){M(!0);try{await i()}catch(W){xe.error("Home shuffle button - shuffleAllSongs failed:",W),xe.error("Shuffle all failed:",W)}finally{M(!1)}}},disabled:C,className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors disabled:opacity-50","aria-label":"Shuffle all songs",children:C?e.jsx("div",{className:"w-5 h-5 border-2 border-zinc-400 border-t-white rounded-full animate-spin"}):e.jsx(Ye,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>l(!0),className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors","aria-label":"Search",children:e.jsx(nt,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>Y("/settings"),className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors","aria-label":"Settings",children:e.jsx(rt,{className:"w-5 h-5"})})]})]})}),e.jsx(Je,{isOpen:r,onClose:p,title:o,searchQuery:q,onSearchChange:ue,onClearSearch:B,isLoading:oe,results:F,sections:at,filterConfig:{showGenreFilter:!0,showYearFilter:!0,showGroupingFilters:!0},filterState:{selectedGenres:Z,yearRange:V,selectedGroupings:Q},onOpenFilterSheet:R,groupingCategories:k,onOpenGroupingFilterSheet:j,onArtistClick:v,onAlbumClick:D,onSongClick:P,onPlaylistClick:z,onPlayAllSongs:he,onAddSongsToQueue:pe,isQueueSidebarOpen:I,desktopSearchInputRef:f,mobileSearchInputRef:u}),c==="genre"&&e.jsx(je,{isOpen:y,onClose:()=>a(!1),filterType:"genre",genres:g,selectedValues:Z,onApply:b}),c==="year"&&e.jsx(je,{isOpen:y,onClose:()=>a(!1),filterType:"year",availableYears:S,yearRange:V,onApplyYear:A}),c==="grouping"&&d&&e.jsx(je,{isOpen:y,onClose:()=>a(!1),filterType:"grouping",groupingCategory:d,selectedGroupingValues:Q[d.key]||[],onApplyGrouping:ne,groupingMatchMode:J[d.key]||"or",onGroupingMatchModeChange:le})]})}function Ne({moodValue:s,moodName:o,albumId:r}){const l=Se(),{recordMoodAccess:u}=H(),f=()=>{u(s),l(`/mood/${encodeURIComponent(s)}`)};return e.jsxs("button",{onClick:f,className:"bg-zinc-800/50 rounded border border-zinc-700/50 hover:bg-zinc-800 transition-colors group text-left flex items-center w-full h-11 overflow-hidden",children:[r&&e.jsx("div",{className:"h-full flex-shrink-0 hidden md:block",children:e.jsx(Ae,{src:L.getAlbumArtUrl(r,56),alt:"",className:"w-full h-full object-cover",showOutline:!1,rounded:""})}),e.jsx("div",{className:"text-sm font-medium text-white group-hover:text-[var(--accent-color)] transition-colors truncate py-2 pl-3",children:o})]})}function Oe({children:s,className:o="",gap:r=12}){const l=t.useRef(null),[u,f]=t.useState(!1),[y,a]=t.useState(!1),[c,n]=t.useState(!1),d=()=>{if(!l.current)return;const{scrollLeft:g,scrollWidth:m,clientWidth:S}=l.current;f(g>0),a(g+S<m-1)};t.useEffect(()=>{d();const g=l.current;if(g)return g.addEventListener("scroll",d,{passive:!0}),window.addEventListener("resize",d),()=>{g.removeEventListener("scroll",d),window.removeEventListener("resize",d)}},[s]);const h=g=>{if(!l.current)return;const m=l.current,S=m.clientWidth+r;m.scrollBy({left:g==="left"?-S:S,behavior:"smooth"})};return e.jsxs("div",{className:"relative",onMouseEnter:()=>n(!0),onMouseLeave:()=>n(!1),children:[e.jsx("div",{ref:l,className:`overflow-x-auto scrollbar-hide ${o}`,style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:s}),u&&c&&e.jsx("button",{onClick:()=>h("left"),className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 w-10 h-10 flex items-center justify-center bg-black/70 hover:bg-black/90 rounded-full transition-colors","aria-label":"Scroll left",children:e.jsx(Ze,{className:"w-6 h-6 text-white"})}),y&&c&&e.jsx("button",{onClick:()=>h("right"),className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 w-10 h-10 flex items-center justify-center bg-black/70 hover:bg-black/90 rounded-full transition-colors","aria-label":"Scroll right",children:e.jsx(et,{className:"w-6 h-6 text-white"})}),e.jsx("style",{children:`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `})]})}function ot(s){let o=0;for(let r=0;r<s.length;r++){const l=s.charCodeAt(r);o=(o<<5)-o+l,o=o&o}return o}function ct(s){const o=new Date().toISOString().split("T")[0];return ot(`${o}-${s}`)}function dt(s){return s?s.charAt(0).toUpperCase()+s.slice(1):""}function ut(s,o,r){const l=o.filter(c=>{var n;return(n=c.Grouping)==null?void 0:n.some(d=>d.toLowerCase()===`mood_${s.toLowerCase()}`)});if(l.length===0)return null;const u=l.filter(c=>c.AlbumId);if(u.length===0)return null;let f=u.filter(c=>!r.has(c.AlbumId));f.length===0&&(f=u);const y=ct(s),a=Math.abs(y)%f.length;return f[a].AlbumId}function ft(s,o){return[...s].sort((r,l)=>{const u=o[r.toLowerCase()]||0,f=o[l.toLowerCase()]||0;return u!==f?f-u:r.localeCompare(l)})}function Le(s,o){const r=Math.ceil(s.length/o),l=[];for(let u=0;u<r;u++)for(let f=0;f<o;f++){const y=f*r+u;y<s.length&&l.push(s[y])}return l}function mt(){const{songs:s,recentlyAccessedMoods:o}=H(),r=t.useRef(null),l=t.useMemo(()=>Ee(s).find(c=>c.key==="mood"),[s]),u=t.useMemo(()=>{if(!l||l.values.length===0)return[];const a=ft(l.values,o),c=new Set;return a.map(n=>{const d=ut(n.toLowerCase(),s,c);return d&&c.add(d),{value:n.toLowerCase(),name:dt(n),albumId:d}})},[l,s,o]);if(u.length===0)return null;const f=6,y=[];for(let a=0;a<u.length;a+=f)y.push(u.slice(a,a+f));return e.jsxs("div",{className:"px-4 mb-12",children:[e.jsx("div",{className:"md:hidden",children:e.jsx("div",{ref:r,className:"overflow-x-auto snap-x snap-mandatory scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:e.jsx("div",{className:"flex",style:{width:`${y.length*100}%`},children:y.map((a,c)=>{const n=Math.ceil(a.length/3);return e.jsx("div",{className:"snap-start flex-shrink-0 w-full",style:{width:`${100/y.length}%`},children:e.jsx("div",{className:"grid grid-cols-3 gap-2",style:{gridTemplateRows:`repeat(${n}, minmax(0, 1fr))`},children:a.map(d=>e.jsx(Ne,{moodValue:d.value,moodName:d.name,albumId:d.albumId},d.value))})},c)})})})}),e.jsx("div",{className:"hidden md:block min-[1680px]:hidden",children:e.jsx(Oe,{gap:8,children:e.jsx("div",{className:"grid grid-rows-2 grid-flow-col gap-2",style:{gridAutoColumns:"calc((100% - 24px) / 4)"},children:Le(u,2).map(a=>e.jsx(Ne,{moodValue:a.value,moodName:a.name,albumId:a.albumId},a.value))})})}),e.jsx("div",{className:"hidden min-[1680px]:block",children:e.jsx(Oe,{gap:8,children:e.jsx("div",{className:"grid grid-rows-2 grid-flow-col gap-2",style:{gridAutoColumns:"calc((100% - 32px) / 5)"},children:Le(u,2).map(a=>e.jsx(Ne,{moodValue:a.value,moodName:a.name,albumId:a.albumId},a.value))})})}),e.jsx("style",{children:`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `})]})}function ke({album:s,onNavigate:o,onContextMenu:r}){var n,d;const[l,u]=t.useState(!1),f=t.useRef(!1),y=h=>{if(f.current){f.current=!1;return}o(s.Id)},a=h=>{h.preventDefault(),h.stopPropagation(),f.current=!0,r(s,"desktop",{x:h.clientX,y:h.clientY}),setTimeout(()=>{f.current=!1},300)},c=Te({onLongPress:h=>{h.preventDefault(),f.current=!0,r(s,"mobile")},onClick:()=>{if(f.current){f.current=!1;return}y()}});return e.jsxs("button",{onClick:()=>{if(f.current){f.current=!1;return}y()},onContextMenu:a,...c,className:"text-left group",children:[e.jsx("div",{className:"aspect-square rounded overflow-hidden mb-2 bg-zinc-900 flex items-center justify-center",children:l?e.jsx(Ie,{className:"w-12 h-12 text-gray-500"}):e.jsx(Ae,{src:L.getAlbumArtUrl(s.Id,474),alt:s.Name,className:"w-full h-full object-cover",showOutline:!0,rounded:"rounded",onError:()=>u(!0)})}),e.jsx("div",{className:"text-sm font-medium text-white truncate group-hover:text-[var(--accent-color)] transition-colors",children:s.Name}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:s.AlbumArtist||((d=(n=s.ArtistItems)==null?void 0:n[0])==null?void 0:d.Name)||"Unknown Artist"})]})}function ht(){const{recentlyAdded:s,setRecentlyAdded:o,setLoading:r}=H(),l=Se(),u=t.useRef(null),[f,y]=t.useState(!1),[a,c]=t.useState("mobile"),[n,d]=t.useState(null),[h,g]=t.useState(null);if(t.useEffect(()=>{(async()=>{r("recentlyAdded",!0);try{const k=await L.getRecentlyAdded(18);o(k.Items||[])}catch(k){xe.error("Failed to load recently added:",k)}finally{r("recentlyAdded",!1)}})()},[o,r]),!s||s.length===0)return null;const m=6,S=[];for(let w=0;w<s.length;w+=m)S.push(s.slice(w,w+m));return e.jsxs("div",{className:"px-4 mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Recently Added"}),e.jsx("div",{className:"md:hidden",children:e.jsx("div",{ref:u,className:"overflow-x-auto snap-x snap-mandatory scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:e.jsx("div",{className:"flex",style:{width:`${S.length*100}%`},children:S.map((w,k)=>{const O=Math.ceil(w.length/3);return e.jsx("div",{className:"snap-start flex-shrink-0 w-full",style:{width:`${100/S.length}%`},children:e.jsx("div",{className:"grid grid-cols-3 gap-3",style:{gridTemplateRows:`repeat(${O}, minmax(0, 1fr))`},children:w.map(T=>e.jsx(ke,{album:T,onNavigate:$=>l(`/album/${$}`),onContextMenu:($,i,I)=>{g($),c(i||"desktop"),d(I||null),y(!0)}},T.Id))})},k)})})})}),e.jsx("div",{className:"hidden md:block min-[1680px]:hidden",children:e.jsx("div",{className:"grid grid-cols-4 gap-3",children:s.slice(0,8).map(w=>e.jsx(ke,{album:w,onNavigate:k=>l(`/album/${k}`),onContextMenu:(k,O,T)=>{g(k),c(O||"desktop"),d(T||null),y(!0)}},w.Id))})}),e.jsx("div",{className:"hidden min-[1680px]:block",children:e.jsx("div",{className:"grid grid-cols-5 gap-3",children:s.slice(0,10).map(w=>e.jsx(ke,{album:w,onNavigate:k=>l(`/album/${k}`),onContextMenu:(k,O,T)=>{g(k),c(O||"desktop"),d(T||null),y(!0)}},w.Id))})}),e.jsx("style",{children:`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `}),e.jsx(we,{item:h,itemType:"album",isOpen:f,onClose:()=>{y(!1),g(null)},zIndex:999999,mode:a,position:n||void 0})]})}function pt(){const[s,o]=t.useState(()=>H.persist.hasHydrated());return t.useEffect(()=>{if(H.persist.hasHydrated()){o(!0);return}return H.persist.onFinishHydration(()=>{o(!0)})},[]),s}function ae(s){return s.toLowerCase().replace(/[^a-z0-9]/g,"")}function ge(s){return s.replace(/\s*\(feat\..*?\)/gi,"").replace(/\s*\[feat\..*?\]/gi,"").replace(/\s*ft\..*$/gi,"").replace(/\s*\(with.*?\)/gi,"").replace(/\s*\[with.*?\]/gi,"").replace(/\s*\(explicit\)/gi,"").replace(/\s*\[explicit\]/gi,"").replace(/\s*\(deluxe.*?\)/gi,"").replace(/\s*\[deluxe.*?\]/gi,"").replace(/\s*-\s*single$/gi,"").replace(/\s*-\s*ep$/gi,"").trim()}function $e(s){return s.split(/[,&]/)[0].replace(/\s*feat\..*$/gi,"").replace(/\s*ft\..*$/gi,"").replace(/\s*with\s+.*$/gi,"").trim()}function ze(){const s=H(c=>c.songs),o=H(c=>c.genreSongs),r=pt(),l=t.useMemo(()=>{var d,h;if(!r)return new Map;let c=s;if(c.length===0&&o){const g=new Set;c=Object.values(o).flat().filter(m=>g.has(m.Id)?!1:(g.add(m.Id),!0))}const n=new Map;for(const g of c){const m=ae($e(g.AlbumArtist||((h=(d=g.ArtistItems)==null?void 0:d[0])==null?void 0:h.Name)||""));m&&(n.has(m)||n.set(m,[]),n.get(m).push(g))}return n},[s,o,r]),u=c=>{const n=ae($e(c));if(!n)return null;if(l.has(n))return l.get(n);for(const[d,h]of l)if(d.includes(n)||n.includes(d))return h;return null};return{findSong:(c,n)=>{const d=u(n);if(!d)return null;const h=ae(ge(c));if(!h)return null;for(const g of d){const m=ae(ge(g.Name||""));if(m===h||m.includes(h)||h.includes(m))return g}return null},findAlbum:(c,n)=>{const d=u(n);if(!d)return null;const h=ae(ge(c));if(!h)return null;for(const g of d){if(!g.AlbumId||!g.Album)continue;const m=ae(ge(g.Album));if(m===h||m.includes(h)||h.includes(m))return{albumId:g.AlbumId,albumName:g.Album}}return null},findArtistImageUrl:c=>{var h,g,m;const n=u(c);return!n||n.length===0?null:((m=(g=(h=n[0])==null?void 0:h.ArtistItems)==null?void 0:g[0])==null?void 0:m.Id)||null},artistIndex:l}}function me({title:s,subtitle:o,artworkUrl:r,fallbackArtworkUrl:l,secondFallbackUrl:u,rank:f,isCurrentTrack:y,isInLibrary:a,isMenuOpen:c,subtitleIcon:n,paddingRight:d=!1,imageLoading:h="lazy",onClick:g,onContextMenu:m,onLongPress:S,onExternalClick:w}){const[k,O]=t.useState(!1),[T,$]=t.useState(!1),[i,I]=t.useState(!1);t.useEffect(()=>{O(!1),$(!1),I(!1)},[r]);let C=r;i&&u?C=u:T&&l&&(C=l);const M=()=>{!T&&l?$(!0):!i&&u?I(!0):O(!0)},q=Te({onLongPress:U=>{U.preventDefault(),S==null||S(U)},onClick:U=>g(U)});return e.jsxs("button",{onClick:U=>g(U),onContextMenu:m,...q,className:`w-full flex items-center gap-2 hover:bg-white/10 transition-colors group py-2.5 ${c?"bg-white/10":""} ${d?"pr-4":""}`,children:[e.jsx("div",{className:"w-12 h-12 rounded-sm overflow-hidden flex-shrink-0 bg-zinc-900 self-center flex items-center justify-center",children:k?e.jsx(Ie,{className:"w-6 h-6 text-gray-500"}):e.jsx(Ae,{src:C,alt:s,className:"w-full h-full object-cover",showOutline:!0,rounded:"rounded-sm",loading:h,onError:M})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left flex gap-3 items-baseline",children:[f!==void 0&&e.jsx("span",{className:"text-zinc-500 text-sm flex-shrink-0 w-5 text-right",children:f}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium truncate text-white group-hover:text-[var(--accent-color)] transition-colors",children:s}),e.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-1.5 min-w-0",children:[e.jsx("span",{className:"truncate",children:o}),n&&e.jsx("span",{className:"flex-shrink-0",children:n})]})]})]}),!a&&w&&e.jsx("div",{onClick:U=>{U.stopPropagation(),w(U)},className:"flex-shrink-0 p-2 text-gray-400 hover:text-white cursor-pointer",children:e.jsx(tt,{className:"w-4 h-4"})})]})}function Ce(){return e.jsx("div",{className:"animate-pulse",children:[...Array(5)].map((s,o)=>e.jsxs("div",{className:"flex items-center gap-3 py-2.5",children:[e.jsx("div",{className:"w-12 h-12 rounded-sm bg-zinc-800"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-zinc-800 rounded w-3/4 mb-1.5"}),e.jsx("div",{className:"h-3 bg-zinc-800 rounded w-1/2"})]})]},o))})}function gt(){const{playTrack:s}=ie(),{feedTopSongs:o,feedLastUpdated:r,loading:l,setFeedTopSongs:u,setFeedLastUpdated:f,setLoading:y}=H(),{feedCountry:a,showTop10:c}=ve(),{findSong:n}=ze(),[d,h]=t.useState(!1),[g,m]=t.useState("mobile"),[S,w]=t.useState(null),[k,O]=t.useState(null),[T,$]=t.useState(!1),[i,I]=t.useState(!1),[C,M]=t.useState(null),[q,U]=t.useState(null),[oe,F]=t.useState(!1),[Z,ee]=t.useState("mobile"),[V,te]=t.useState(null),[Q,se]=t.useState(null),[J,X]=t.useState(null),_=t.useCallback(async(v=!1)=>{const D=Date.now();if(!(!v&&r&&D-r<ye)){y("feed",!0),I(!1);try{const P=await We(a,10);u(P),f(D)}catch(P){console.error("Failed to fetch top songs:",P),I(!0)}finally{y("feed",!1)}}},[a,r,u,f,y]);t.useEffect(()=>{if(c){const v=Date.now();(!r||v-r>=ye)&&_(!0)}},[c,a]);const ce=async(v,D,P)=>{if(D){const z=await L.getSongById(D.Id);z&&s(z)}else await Y(v,P)},Y=async(v,D)=>{const P=!window.matchMedia("(hover: hover) and (pointer: fine)").matches;m(P?"mobile":"desktop"),P||w({x:D.clientX,y:D.clientY}),M(v.name),U(v.id),$(!0),h(!0);try{const z=await De(v.url);if(z&&Object.keys(z.linksByPlatform).length>0)O(z);else{const B=be(v.artistName,v.name);O(B)}}catch{const z=be(v.artistName,v.name);O(z)}finally{$(!1)}};if(!c)return null;const K=o.length>0,ue=l.feed&&!K&&!i;return e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Top 10"}),ue?e.jsx(Ce,{}):K?e.jsx("div",{className:"space-y-0",children:o.map((v,D)=>{const P=n(v.name,v.artistName),z=P!==null;return e.jsx(me,{rank:D+1,title:v.name,subtitle:v.artistName,artworkUrl:z&&P.AlbumId?L.getAlbumArtUrl(P.AlbumId,96):Ve(v.artworkUrl100,96),isInLibrary:z,isMenuOpen:J===v.id||q===v.id&&d,onClick:B=>ce(v,P,B),onContextMenu:async B=>{if(B.preventDefault(),P){const p=await L.getSongById(P.Id);p&&(se(p),X(v.id),ee("desktop"),te({x:B.clientX,y:B.clientY}),F(!0))}},onLongPress:async()=>{if(P){const B=await L.getSongById(P.Id);B&&(se(B),X(v.id),ee("mobile"),te(null),F(!0))}},onExternalClick:B=>Y(v,B)},v.id)})}):e.jsx("div",{className:"py-8 text-left text-gray-500 text-sm",children:"Could not load charts"}),e.jsx(Ue,{isOpen:d,onClose:()=>{h(!1),O(null),U(null)},odesliData:k,loading:T,title:C||void 0,mode:g,position:S||void 0}),e.jsx(we,{item:Q,itemType:"song",isOpen:oe,onClose:()=>{F(!1),se(null),X(null)},zIndex:99999,mode:Z,position:V||void 0})]})}function xt(){const s=Se(),{playTrack:o}=ie(),{feedNewReleases:r,feedLastUpdated:l,loading:u,setFeedNewReleases:f,setFeedLastUpdated:y,setLoading:a}=H(),{showNewReleases:c,muspyRssUrl:n}=ve(),{findAlbum:d,findSong:h,findArtistImageUrl:g}=ze(),[m,S]=t.useState(!1),[w,k]=t.useState("mobile"),[O,T]=t.useState(null),[$,i]=t.useState(null),[I,C]=t.useState(!1),[M,q]=t.useState(!1),[U,oe]=t.useState(null),[F,Z]=t.useState(null),[ee,V]=t.useState(!1),[te,Q]=t.useState("mobile"),[se,J]=t.useState(null),[X,_]=t.useState(null),[ce,Y]=t.useState(null),K=t.useCallback(async(p=!1)=>{if(!n)return;const R=Date.now();if(!(!p&&l&&R-l<ye)){a("feed",!0),q(!1);try{const b=await Xe(n,10);f(b),y(R)}catch(b){console.error("Failed to fetch Muspy releases:",b),q(!0)}finally{a("feed",!1)}}},[n,l,f,y,a]);t.useEffect(()=>{if(c&&n){const p=Date.now();(!l||p-l>=ye)&&K(!0)}},[c,n]),t.useEffect(()=>{r.forEach(p=>{if(!p.id.startsWith("muspy-")){const R=new window.Image;R.src=Re(p.id,250)}})},[r]);const de=t.useRef(new Set);t.useEffect(()=>{const p=async()=>{const R=r.filter(b=>b.id.startsWith("muspy-")&&!de.current.has(b.id));if(R.length!==0)for(const b of R){de.current.add(b.id);try{console.log(`[FeedSection] Searching MB for: ${b.title} - ${b.artistName}`);const A=await Qe(b.artistName,b.title);if(A){console.log(`[FeedSection] Found MBID for "${b.title}": ${A.id} (${A.type})`);const ne=H.getState().feedNewReleases.map(le=>le.id===b.id?{...le,id:A.id,type:A.type}:le);f(ne)}else console.log(`[FeedSection] No MBID found for "${b.title}"`)}catch(A){console.error(`[FeedSection] Failed to search MB for "${b.title}":`,A)}}};r.length>0&&p()},[r,f]);const ue=async(p,R,b)=>{if(R)if(R.type==="song"){const A=await L.getSongById(R.song.Id);A&&o(A)}else s(`/album/${R.albumId}`);else await v(p,b)},v=async(p,R)=>{const b=!window.matchMedia("(hover: hover) and (pointer: fine)").matches;k(b?"mobile":"desktop"),b||T({x:R.clientX,y:R.clientY}),oe(p.title),Z(p.id),C(!0),S(!0);const A=p.mbUrl&&!p.id.startsWith("muspy-");try{let j=null;if(A&&(j=await De(p.mbUrl)),j&&Object.keys(j.linksByPlatform).length>0)i(j);else{const ne=be(p.artistName,p.title);i(ne)}}catch{const j=be(p.artistName,p.title);i(j)}finally{C(!1)}};if(!c||!n)return null;const D=r.length>0,P=u.feed,z=!!n,B=P&&!D&&!M&&z;return e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"New Releases"}),B?e.jsx(Ce,{}):D?e.jsx("div",{className:"space-y-0",children:r.map(p=>{const R=p.type==="Single",b=R?h(p.title,p.artistName):null,A=b?null:d(p.title,p.artistName),j=b?{type:"song",song:b}:A?{type:"album",albumId:A.albumId}:null,ne=j!==null,he=!p.id.startsWith("muspy-")?Re(p.id,250):null,pe=g(p.artistName),re=pe?L.getArtistImageUrl(pe,96):null,x=(j==null?void 0:j.type)==="song"&&(b!=null&&b.AlbumId)?L.getAlbumArtUrl(b.AlbumId,96):(j==null?void 0:j.type)==="album"&&(A!=null&&A.albumId)?L.getAlbumArtUrl(A.albumId,96):null;let N,E,W;he?(N=he,E=x||void 0,W=re||void 0):x?(N=x,E=re||void 0):N=re||"";const Me=new Date(p.releaseDate),Pe=!isNaN(Me.getTime())?Me.toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",Be=Pe?`${p.artistName} • ${Pe}`:p.artistName,Ge=R?e.jsx(qe,{className:"w-3 h-3"}):e.jsx(Ie,{className:"w-3 h-3"});return e.jsx(me,{title:p.title,subtitle:Be,subtitleIcon:Ge,artworkUrl:N,fallbackArtworkUrl:E,secondFallbackUrl:W,isInLibrary:ne,imageLoading:"eager",isMenuOpen:ce===p.id||F===p.id&&m,onClick:G=>ue(p,j,G),onContextMenu:async G=>{if(G.preventDefault(),(j==null?void 0:j.type)==="song"&&b){const fe=await L.getSongById(b.Id);fe&&(_(fe),Y(p.id),Q("desktop"),J({x:G.clientX,y:G.clientY}),V(!0))}else if((j==null?void 0:j.type)==="album"&&A){const fe=await L.getAlbumById(A.albumId);fe&&(_(fe),Y(p.id),Q("desktop"),J({x:G.clientX,y:G.clientY}),V(!0))}},onLongPress:async()=>{if((j==null?void 0:j.type)==="song"&&b){const G=await L.getSongById(b.Id);G&&(_(G),Y(p.id),Q("mobile"),J(null),V(!0))}else if((j==null?void 0:j.type)==="album"&&A){const G=await L.getAlbumById(A.albumId);G&&(_(G),Y(p.id),Q("mobile"),J(null),V(!0))}},onExternalClick:G=>v(p,G)},p.id)})}):z?e.jsx("div",{className:"py-8 text-left text-gray-500 text-sm",children:M?"Failed to load releases":"No new releases found"}):e.jsx("div",{className:"py-8 text-center text-gray-500 text-sm",children:"Configure Muspy RSS in settings"}),e.jsx(Ue,{isOpen:m,onClose:()=>{S(!1),i(null),Z(null)},odesliData:$,loading:I,title:U||void 0,mode:w,position:O||void 0}),e.jsx(we,{item:X,itemType:(X==null?void 0:X.Type)==="Audio"?"song":"album",isOpen:ee,onClose:()=>{V(!1),_(null),Y(null)},zIndex:99999,mode:te,position:se||void 0})]})}function yt({twoColumns:s=!1}){const{recentlyPlayed:o,loading:r,setRecentlyPlayed:l,setLoading:u}=H(),{showRecentlyPlayed:f}=ve(),{playTrack:y}=ie(),a=_e(),[c,n]=t.useState(!1),[d,h]=t.useState("mobile"),[g,m]=t.useState(null),[S,w]=t.useState(null);t.useEffect(()=>{f&&(async()=>{u("recentlyPlayed",!0);try{const I=await L.getRecentlyPlayed(10);l(I.Items||[])}catch(I){console.error(I)}finally{u("recentlyPlayed",!1)}})()},[f,l,u]);const k=i=>{y(i,o)};if(!f)return null;const O=o&&o.length>0,$=r.recentlyPlayed&&!O;return e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Recently Played"}),$?e.jsx(Ce,{}):O?e.jsx("div",{className:s?"md:grid md:grid-cols-2 md:gap-3 min-[1680px]:block":"",children:s?e.jsxs(e.Fragment,{children:[e.jsx("div",{children:o.slice(0,5).map(i=>{var I,C;return e.jsx(me,{title:i.Name||"Unknown",subtitle:`${i.AlbumArtist||((C=(I=i.ArtistItems)==null?void 0:I[0])==null?void 0:C.Name)||"Unknown Artist"}${i.Album?` • ${i.Album}`:""}`,artworkUrl:L.getAlbumArtUrl(i.AlbumId||i.Id,96),isCurrentTrack:(a==null?void 0:a.Id)===i.Id,isInLibrary:!0,isMenuOpen:(S==null?void 0:S.Id)===i.Id,paddingRight:!0,onClick:()=>k(i),onContextMenu:M=>{M.preventDefault(),w(i),h("desktop"),m({x:M.clientX,y:M.clientY}),n(!0)},onLongPress:()=>{w(i),h("mobile"),m(null),n(!0)}},i.Id)})}),e.jsx("div",{children:o.slice(5,10).map(i=>{var I,C;return e.jsx(me,{title:i.Name||"Unknown",subtitle:`${i.AlbumArtist||((C=(I=i.ArtistItems)==null?void 0:I[0])==null?void 0:C.Name)||"Unknown Artist"}${i.Album?` • ${i.Album}`:""}`,artworkUrl:L.getAlbumArtUrl(i.AlbumId||i.Id,96),isCurrentTrack:(a==null?void 0:a.Id)===i.Id,isInLibrary:!0,isMenuOpen:(S==null?void 0:S.Id)===i.Id,paddingRight:!0,onClick:()=>k(i),onContextMenu:M=>{M.preventDefault(),w(i),h("desktop"),m({x:M.clientX,y:M.clientY}),n(!0)},onLongPress:()=>{w(i),h("mobile"),m(null),n(!0)}},i.Id)})})]}):o.map(i=>{var I,C;return e.jsx(me,{title:i.Name||"Unknown",subtitle:`${i.AlbumArtist||((C=(I=i.ArtistItems)==null?void 0:I[0])==null?void 0:C.Name)||"Unknown Artist"}${i.Album?` • ${i.Album}`:""}`,artworkUrl:L.getAlbumArtUrl(i.AlbumId||i.Id,96),isCurrentTrack:(a==null?void 0:a.Id)===i.Id,isInLibrary:!0,isMenuOpen:(S==null?void 0:S.Id)===i.Id,paddingRight:!0,onClick:()=>k(i),onContextMenu:M=>{M.preventDefault(),w(i),h("desktop"),m({x:M.clientX,y:M.clientY}),n(!0)},onLongPress:()=>{w(i),h("mobile"),m(null),n(!0)}},i.Id)})}):null,e.jsx(we,{item:S,itemType:"song",isOpen:c,onClose:()=>{n(!1),w(null)},zIndex:99999,mode:d,position:g||void 0})]})}function It(){const[s,o]=t.useState(!1),{recentlyAdded:r,recentlyPlayed:l,loading:u}=H(),{showMoodCards:f,showTop10:y,showNewReleases:a,showRecentlyPlayed:c,muspyRssUrl:n}=ve(),d=t.useRef(!1),{isQueueSidebarOpen:h}=ie();t.useEffect(()=>{(u.recentlyAdded||u.recentlyPlayed)&&(d.current=!0)},[u.recentlyAdded,u.recentlyPlayed]);const m=[y,a&&!!n,c].filter(Boolean).length,S=d.current&&!u.recentlyAdded&&!u.recentlyPlayed&&r.length===0&&l.length===0;return e.jsxs("div",{className:"pb-20",children:[e.jsx("div",{className:`fixed top-0 left-0 right-0 bg-black z-10 lg:left-16 transition-[left,right] duration-300 ${h?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top))"},children:e.jsx("div",{className:"max-w-[768px] min-[1680px]:max-w-[1080px] w-full mx-auto",children:e.jsx(it,{onSearchStateChange:o})})}),e.jsx("div",{className:`fixed left-0 right-0 z-[60] lg:left-16 transition-[left,right] duration-300 ${h?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top) + 4.5rem - 2px)",height:"24px",background:"linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent)"}}),e.jsx("div",{className:s?"hidden [@media((hover:hover)_and_(pointer:fine)_and_(min-width:1024px))]:block":"",style:{paddingTop:"calc(env(safe-area-inset-top) + 4.5rem + 24px)"},children:e.jsxs("div",{className:"w-full",children:[f&&e.jsx(mt,{}),e.jsx("div",{className:"mt-4 pb-4",children:e.jsx(ht,{})}),m>0&&e.jsxs("div",{className:`
              mt-4 px-4
              ${m>=2?"md:grid md:gap-3":""}
              ${m===2?"md:grid-cols-2":""}
              ${m>=3?"md:grid-cols-2 min-[1680px]:grid-cols-3":""}
            `,children:[c&&e.jsx("div",{className:m===3?"md:col-span-2 min-[1680px]:col-span-1":"",children:e.jsx(yt,{twoColumns:m===3})}),y&&e.jsx("div",{children:e.jsx(gt,{})}),a&&e.jsx("div",{children:e.jsx(xt,{})})]}),S&&e.jsx("div",{className:"flex items-center justify-center py-16 text-gray-400",children:e.jsx("p",{children:"No music found"})})]})})]})}export{It as default};
