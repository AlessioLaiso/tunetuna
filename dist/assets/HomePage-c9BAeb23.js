import{c as Fe,r as n,u as _,g as Ee,a as de,b as ne,d as Ye,j as e,S as _e,l as be,e as T,I as ke,C as ve,f as Te,D as Ce,h as je,i as We,F as Se,k as Ve,m as Xe,P as Ue,n as Qe,o as Re,p as De,q as we,s as qe,M as Je}from"./index-BYKDqJ8o.js";import{S as Ke}from"./search-QndjWdlH.js";import{u as Ze,F as Ae}from"./useSearch-Cp7mq4aB.js";import{C as et,a as tt}from"./chevron-right-C8kZkqUv.js";import{E as st}from"./ellipsis-40ShD4hH.js";import"./tag-C3OfJ6eg.js";import"./piano-Dd66CmwD.js";/**
 * @license lucide-react v0.560.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],lt=Fe("search",nt);/**
 * @license lucide-react v0.560.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=[["path",{d:"M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915",key:"1i5ecw"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]],rt=Fe("settings",it),at=[{type:"artists",limit:5},{type:"albums",limit:12},{type:"playlists"},{type:"songs"}];function ot({onSearchStateChange:s,title:d="Search"}){const[r,i]=n.useState(!1),m=n.useRef(null),x=n.useRef(null),[p,f]=n.useState(!1),[l,o]=n.useState(null),[a,b]=n.useState(null),{genres:c,songs:h}=_(),[N,S]=n.useState([]),v=n.useMemo(()=>Ee(h),[h]),{playAlbum:F,addToQueue:M,playTrack:E,shuffleAllSongs:U,isQueueSidebarOpen:G}=de(),[t,j]=n.useState(!1),{searchQuery:O,setSearchQuery:L,isSearching:P,searchResults:$,selectedGenres:D,setSelectedGenres:Z,yearRange:Q,setYearRange:le,selectedGroupings:J,setSelectedGroupings:ue,groupingMatchModes:K,setGroupingMatchModes:ee,clearSearch:W,clearAll:fe}=Ze({debounceMs:300});n.useEffect(()=>{if(t){const y=setTimeout(()=>{j(!1)},1e4);return()=>clearTimeout(y)}},[t]);const V=ne(),[te,se]=Ye();n.useEffect(()=>{const y=te.get("yearMin"),k=te.get("yearMax"),z=te.get("genre");let X=!1;(y||k)&&(le({min:y?parseInt(y,10):null,max:k?parseInt(k,10):null}),X=!0),z&&(Z([z]),X=!0),X&&(i(!0),se({},{replace:!0}))},[]),n.useEffect(()=>{(async()=>{try{const k=_.getState();if(k.years.length>0)S(k.years);else{const z=await T.getYears();S(z)}}catch(k){be.error("Failed to load filter values:",k)}})()},[]);const pe=y=>{L(y),y.trim().length>0&&!r&&i(!0)},ie=y=>{V(`/artist/${y}`),i(!1),W()},A=y=>{V(`/album/${y}`),i(!1),W()},H=y=>{E(y,[y])},C=y=>{V(`/playlist/${y}`),i(!1),W()},B=()=>{W()},u=()=>{i(!1),fe()},R=y=>{o(y),f(!0)},w=y=>{Z(y)},I=y=>{le(y)},g=y=>{b(y),o("grouping"),f(!0)},q=(y,k)=>{ue(z=>({...z,[y]:k}))},re=(y,k)=>{ee(z=>({...z,[y]:k}))},xe=()=>{$!=null&&$.songs&&$.songs.length>0&&F($.songs)},ae=()=>{$!=null&&$.songs&&$.songs.length>0&&M($.songs)},oe=r;return n.useEffect(()=>{s&&s(oe)},[oe,s]),n.useEffect(()=>{if(r){const k=window.matchMedia("(hover: hover) and (pointer: fine) and (min-width: 1024px)").matches?x:m;setTimeout(()=>{var z;if((z=k.current)==null||z.focus(),k.current){const X=k.current.value.length;k.current.setSelectionRange(X,X)}},50)}},[r]),n.useEffect(()=>{if(!r)return;const y=k=>{k.key==="Escape"&&(k.preventDefault(),k.stopPropagation(),u())};return window.addEventListener("keydown",y,!0),()=>window.removeEventListener("keydown",y,!0)},[r]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-4 md:pl-2 md:pr-4 pt-4 pb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-2xl font-bold text-white",children:"Tunetuna"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:async()=>{const y=de.getState(),{isShuffleAllActive:k,isShuffleGenreActive:z}=y;if(!(t||k||z)){j(!0);try{await U()}catch(X){be.error("Home shuffle button - shuffleAllSongs failed:",X),be.error("Shuffle all failed:",X)}finally{j(!1)}}},disabled:t,className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors disabled:opacity-50","aria-label":"Shuffle all songs",children:t?e.jsx("div",{className:"w-5 h-5 border-2 border-zinc-400 border-t-white rounded-full animate-spin"}):e.jsx(_e,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>i(!0),className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors","aria-label":"Search",children:e.jsx(lt,{className:"w-5 h-5"})}),e.jsx("button",{onClick:()=>V("/settings"),className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors","aria-label":"Settings",children:e.jsx(rt,{className:"w-5 h-5"})})]})]})}),e.jsx(Ke,{isOpen:r,onClose:u,title:d,searchQuery:O,onSearchChange:pe,onClearSearch:B,isLoading:P,results:$,sections:at,filterConfig:{showGenreFilter:!0,showYearFilter:!0,showGroupingFilters:!0},filterState:{selectedGenres:D,yearRange:Q,selectedGroupings:J},onOpenFilterSheet:R,groupingCategories:v,onOpenGroupingFilterSheet:g,onArtistClick:ie,onAlbumClick:A,onSongClick:H,onPlaylistClick:C,onPlayAllSongs:xe,onAddSongsToQueue:ae,isQueueSidebarOpen:G,desktopSearchInputRef:x,mobileSearchInputRef:m}),l==="genre"&&e.jsx(Ae,{isOpen:p,onClose:()=>f(!1),filterType:"genre",genres:c,selectedValues:D,onApply:w}),l==="year"&&e.jsx(Ae,{isOpen:p,onClose:()=>f(!1),filterType:"year",availableYears:N,yearRange:Q,onApplyYear:I}),l==="grouping"&&a&&e.jsx(Ae,{isOpen:p,onClose:()=>f(!1),filterType:"grouping",groupingCategory:a,selectedGroupingValues:J[a.key]||[],onApplyGrouping:q,groupingMatchMode:K[a.key]||"or",onGroupingMatchModeChange:re})]})}function Ne({moodValue:s,moodName:d,albumId:r}){const i=ne(),{recordMoodAccess:m}=_(),x=()=>{m(s),i(`/mood/${encodeURIComponent(s)}`)};return e.jsxs("button",{onClick:x,className:"bg-zinc-800/50 rounded border border-zinc-700/50 hover:bg-zinc-800 transition-colors group text-left flex items-center w-full h-11 overflow-hidden",children:[r&&e.jsx("div",{className:"h-full flex-shrink-0 hidden md:block",children:e.jsx(ke,{src:T.getAlbumArtUrl(r,56),alt:"",className:"w-full h-full object-cover",showOutline:!1,rounded:""})}),e.jsx("div",{className:"text-sm font-medium text-white group-hover:text-[var(--accent-color)] transition-colors truncate py-2 pl-3",children:d})]})}function Oe({children:s,className:d="",gap:r=12}){const i=n.useRef(null),[m,x]=n.useState(!1),[p,f]=n.useState(!1),[l,o]=n.useState(!1),a=()=>{if(!i.current)return;const{scrollLeft:c,scrollWidth:h,clientWidth:N}=i.current;x(c>0),f(c+N<h-1)};n.useEffect(()=>{a();const c=i.current;if(c)return c.addEventListener("scroll",a,{passive:!0}),window.addEventListener("resize",a),()=>{c.removeEventListener("scroll",a),window.removeEventListener("resize",a)}},[s]);const b=c=>{if(!i.current)return;const h=i.current,N=h.clientWidth+r;h.scrollBy({left:c==="left"?-N:N,behavior:"smooth"})};return e.jsxs("div",{className:"relative",onMouseEnter:()=>o(!0),onMouseLeave:()=>o(!1),children:[e.jsx("div",{ref:i,className:`overflow-x-auto scrollbar-hide ${d}`,style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:s}),m&&l&&e.jsx("button",{onClick:()=>b("left"),className:"absolute left-0 top-1/2 -translate-y-1/2 z-10 w-10 h-10 flex items-center justify-center bg-black/70 hover:bg-black/90 rounded-full transition-colors","aria-label":"Scroll left",children:e.jsx(et,{className:"w-6 h-6 text-white"})}),p&&l&&e.jsx("button",{onClick:()=>b("right"),className:"absolute right-0 top-1/2 -translate-y-1/2 z-10 w-10 h-10 flex items-center justify-center bg-black/70 hover:bg-black/90 rounded-full transition-colors","aria-label":"Scroll right",children:e.jsx(tt,{className:"w-6 h-6 text-white"})}),e.jsx("style",{children:`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `})]})}function ct(s){let d=0;for(let r=0;r<s.length;r++){const i=s.charCodeAt(r);d=(d<<5)-d+i,d=d&d}return d}function dt(s){const d=new Date().toISOString().split("T")[0];return ct(`${d}-${s}`)}function ut(s){return s?s.charAt(0).toUpperCase()+s.slice(1):""}function ft(s,d,r){const i=d.filter(l=>{var o;return(o=l.Grouping)==null?void 0:o.some(a=>a.toLowerCase()===`mood_${s.toLowerCase()}`)});if(i.length===0)return null;const m=i.filter(l=>l.AlbumId);if(m.length===0)return null;let x=m.filter(l=>!r.has(l.AlbumId));x.length===0&&(x=m);const p=dt(s),f=Math.abs(p)%x.length;return x[f].AlbumId}function mt(s,d){return[...s].sort((r,i)=>{const m=d[r.toLowerCase()]||0,x=d[i.toLowerCase()]||0;return m!==x?x-m:r.localeCompare(i)})}function Le(s,d){const r=Math.ceil(s.length/d),i=[];for(let m=0;m<r;m++)for(let x=0;x<d;x++){const p=x*r+m;p<s.length&&i.push(s[p])}return i}function ht(){const{songs:s,recentlyAccessedMoods:d}=_(),r=n.useRef(null),i=n.useMemo(()=>Ee(s).find(l=>l.key==="mood"),[s]),m=n.useMemo(()=>{if(!i||i.values.length===0)return[];const f=mt(i.values,d),l=new Set;return f.map(o=>{const a=ft(o.toLowerCase(),s,l);return a&&l.add(a),{value:o.toLowerCase(),name:ut(o),albumId:a}})},[i,s,d]);if(m.length===0)return null;const x=6,p=[];for(let f=0;f<m.length;f+=x)p.push(m.slice(f,f+x));return e.jsxs("div",{className:"px-4 mb-12",children:[e.jsx("div",{className:"md:hidden",children:e.jsx("div",{ref:r,className:"overflow-x-auto snap-x snap-mandatory scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:e.jsx("div",{className:"flex gap-2",children:p.map((f,l)=>{const o=Math.ceil(f.length/3);return e.jsx("div",{className:"snap-start flex-shrink-0",style:{width:"calc(100% - 8px)"},children:e.jsx("div",{className:"grid grid-cols-3 gap-2",style:{gridTemplateRows:`repeat(${o}, minmax(0, 1fr))`},children:f.map(a=>e.jsx(Ne,{moodValue:a.value,moodName:a.name,albumId:a.albumId},a.value))})},l)})})})}),e.jsx("div",{className:"hidden md:block min-[1680px]:hidden",children:e.jsx(Oe,{gap:8,children:e.jsx("div",{className:"grid grid-rows-2 grid-flow-col gap-2",style:{gridAutoColumns:"calc((100% - 24px) / 4)"},children:Le(m,2).map(f=>e.jsx(Ne,{moodValue:f.value,moodName:f.name,albumId:f.albumId},f.value))})})}),e.jsx("div",{className:"hidden min-[1680px]:block",children:e.jsx(Oe,{gap:8,children:e.jsx("div",{className:"grid grid-rows-2 grid-flow-col gap-2",style:{gridAutoColumns:"calc((100% - 32px) / 5)"},children:Le(m,2).map(f=>e.jsx(Ne,{moodValue:f.value,moodName:f.name,albumId:f.albumId},f.value))})})}),e.jsx("style",{children:`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `})]})}function Ie({album:s,onNavigate:d,onContextMenu:r}){var a,b,c,h,N,S,v,F,M,E,U,G;const i=ne(),[m,x]=n.useState(!1),p=n.useRef(!1),f=t=>{if(p.current){p.current=!1;return}d(s.Id)},l=t=>{t.preventDefault(),t.stopPropagation(),p.current=!0,r(s,"desktop",{x:t.clientX,y:t.clientY}),setTimeout(()=>{p.current=!1},300)},o=Te({onLongPress:t=>{t.preventDefault(),p.current=!0,r(s,"mobile")},onClick:()=>{if(p.current){p.current=!1;return}f()}});return e.jsxs("button",{onClick:()=>{if(p.current){p.current=!1;return}f()},onContextMenu:l,...o,className:"text-left group",children:[e.jsx("div",{className:"aspect-square rounded overflow-hidden mb-2 bg-zinc-900 flex items-center justify-center",children:m?e.jsx(Ce,{className:"w-12 h-12 text-gray-500"}):e.jsx(ke,{src:T.getAlbumArtUrl(s.Id,474),alt:s.Name,className:"w-full h-full object-cover",showOutline:!0,rounded:"rounded",onError:()=>x(!0)})}),e.jsx("div",{className:"text-sm font-medium text-white truncate group-hover:text-[var(--accent-color)] transition-colors",children:s.Name}),e.jsx("div",{className:"text-xs text-gray-400 truncate",children:(b=(a=s.AlbumArtists)==null?void 0:a[0])!=null&&b.Id||(h=(c=s.ArtistItems)==null?void 0:c[0])!=null&&h.Id?e.jsx("span",{className:"clickable-text",onMouseDown:t=>t.stopPropagation(),onClick:t=>{var j,O;t.stopPropagation(),i(`/artist/${((O=(j=s.AlbumArtists)==null?void 0:j[0])==null?void 0:O.Id)||s.ArtistItems[0].Id}`)},children:s.AlbumArtist||((S=(N=s.AlbumArtists)==null?void 0:N[0])==null?void 0:S.Name)||((F=(v=s.ArtistItems)==null?void 0:v[0])==null?void 0:F.Name)||"Unknown Artist"}):s.AlbumArtist||((E=(M=s.AlbumArtists)==null?void 0:M[0])==null?void 0:E.Name)||((G=(U=s.ArtistItems)==null?void 0:U[0])==null?void 0:G.Name)||"Unknown Artist"})]})}function pt(){const{recentlyAdded:s,setRecentlyAdded:d,setLoading:r}=_(),i=ne(),m=n.useRef(null),[x,p]=n.useState(!1),[f,l]=n.useState("mobile"),[o,a]=n.useState(null),[b,c]=n.useState(null);if(n.useEffect(()=>{(async()=>{r("recentlyAdded",!0);try{const v=await T.getRecentlyAdded(18);d(v.Items||[])}catch(v){be.error("Failed to load recently added:",v)}finally{r("recentlyAdded",!1)}})()},[d,r]),!s||s.length===0)return null;const h=6,N=[];for(let S=0;S<s.length;S+=h)N.push(s.slice(S,S+h));return e.jsxs("div",{className:"px-4 mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Recently Added"}),e.jsx("div",{className:"md:hidden",children:e.jsx("div",{ref:m,className:"overflow-x-auto snap-x snap-mandatory scrollbar-hide",style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:e.jsx("div",{className:"flex gap-3",children:N.map((S,v)=>{const F=Math.ceil(S.length/3);return e.jsx("div",{className:"snap-start flex-shrink-0",style:{width:"calc(100% - 12px)"},children:e.jsx("div",{className:"grid grid-cols-3 gap-3",style:{gridTemplateRows:`repeat(${F}, minmax(0, 1fr))`},children:S.map(M=>e.jsx(Ie,{album:M,onNavigate:E=>i(`/album/${E}`),onContextMenu:(E,U,G)=>{c(E),l(U||"desktop"),a(G||null),p(!0)}},M.Id))})},v)})})})}),e.jsx("div",{className:"hidden md:block min-[1680px]:hidden",children:e.jsx("div",{className:"grid grid-cols-4 gap-3",children:s.slice(0,8).map(S=>e.jsx(Ie,{album:S,onNavigate:v=>i(`/album/${v}`),onContextMenu:(v,F,M)=>{c(v),l(F||"desktop"),a(M||null),p(!0)}},S.Id))})}),e.jsx("div",{className:"hidden min-[1680px]:block",children:e.jsx("div",{className:"grid grid-cols-5 gap-3",children:s.slice(0,10).map(S=>e.jsx(Ie,{album:S,onNavigate:v=>i(`/album/${v}`),onContextMenu:(v,F,M)=>{c(v),l(F||"desktop"),a(M||null),p(!0)}},S.Id))})}),e.jsx("style",{children:`
        .scrollbar-hide::-webkit-scrollbar {
          display: none;
        }
      `}),e.jsx(ve,{item:b,itemType:"album",isOpen:x,onClose:()=>{p(!1),c(null)},zIndex:999999,mode:f,position:o||void 0})]})}function xt(){const[s,d]=n.useState(()=>_.persist.hasHydrated());return n.useEffect(()=>{if(_.persist.hasHydrated()){d(!0);return}return _.persist.onFinishHydration(()=>{d(!0)})},[]),s}function ce(s){return s.toLowerCase().replace(/[^a-z0-9]/g,"")}function ye(s){return s.replace(/\s*\(feat\..*?\)/gi,"").replace(/\s*\[feat\..*?\]/gi,"").replace(/\s*ft\..*$/gi,"").replace(/\s*\(with.*?\)/gi,"").replace(/\s*\[with.*?\]/gi,"").replace(/\s*\(explicit\)/gi,"").replace(/\s*\[explicit\]/gi,"").replace(/\s*\(deluxe.*?\)/gi,"").replace(/\s*\[deluxe.*?\]/gi,"").replace(/\s*-\s*single$/gi,"").replace(/\s*-\s*ep$/gi,"").trim()}function $e(s){return s.split(/[,&]/)[0].replace(/\s*feat\..*$/gi,"").replace(/\s*ft\..*$/gi,"").replace(/\s*with\s+.*$/gi,"").trim()}function ze(){const s=_(l=>l.songs),d=_(l=>l.genreSongs),r=xt(),i=n.useMemo(()=>{var a,b;if(!r)return new Map;let l=s;if(l.length===0&&d){const c=new Set;l=Object.values(d).flat().filter(h=>c.has(h.Id)?!1:(c.add(h.Id),!0))}const o=new Map;for(const c of l){const h=ce($e(c.AlbumArtist||((b=(a=c.ArtistItems)==null?void 0:a[0])==null?void 0:b.Name)||""));h&&(o.has(h)||o.set(h,[]),o.get(h).push(c))}return o},[s,d,r]),m=l=>{const o=ce($e(l));if(!o)return null;if(i.has(o))return i.get(o);for(const[a,b]of i)if(a.includes(o)||o.includes(a))return b;return null};return{findSong:(l,o)=>{const a=m(o);if(!a)return null;const b=ce(ye(l));if(!b)return null;for(const c of a){const h=ce(ye(c.Name||""));if(h===b||h.includes(b)||b.includes(h))return c}return null},findAlbum:(l,o)=>{const a=m(o);if(!a)return null;const b=ce(ye(l));if(!b)return null;for(const c of a){if(!c.AlbumId||!c.Album)continue;const h=ce(ye(c.Album));if(h===b||h.includes(b)||b.includes(h))return{albumId:c.AlbumId,albumName:c.Album}}return null},findArtistImageUrl:l=>{var b,c,h;const o=m(l);return!o||o.length===0?null:((h=(c=(b=o[0])==null?void 0:b.ArtistItems)==null?void 0:c[0])==null?void 0:h.Id)||null},artistIndex:i}}function he({title:s,subtitle:d,subtitleParts:r,artworkUrl:i,fallbackArtworkUrl:m,secondFallbackUrl:x,rank:p,isCurrentTrack:f,isInLibrary:l,isMenuOpen:o,subtitleIcon:a,paddingRight:b=!1,imageLoading:c="lazy",onClick:h,onContextMenu:N,onLongPress:S,onExternalClick:v}){const[F,M]=n.useState(!1),[E,U]=n.useState(!1),[G,t]=n.useState(!1);n.useEffect(()=>{M(!1),U(!1),t(!1)},[i]);let j=i;G&&x?j=x:E&&m&&(j=m);const O=()=>{!E&&m?U(!0):!G&&x?t(!0):M(!0)},L=Te({onLongPress:P=>{P.preventDefault(),S==null||S(P)},onClick:P=>h(P)});return e.jsxs("button",{onClick:P=>h(P),onContextMenu:N,...L,className:`w-full flex items-center gap-2 hover:bg-white/10 transition-colors group py-2.5 ${o?"bg-white/10":""} ${b?"pr-4":""}`,children:[e.jsx("div",{className:"w-12 h-12 rounded-sm overflow-hidden flex-shrink-0 bg-zinc-900 self-center flex items-center justify-center",children:F?e.jsx(Ce,{className:"w-6 h-6 text-gray-500"}):e.jsx(ke,{src:j,alt:s,className:"w-full h-full object-cover",showOutline:!0,rounded:"rounded-sm",loading:c,onError:O})}),e.jsxs("div",{className:"flex-1 min-w-0 text-left flex gap-3 items-baseline",children:[p!==void 0&&e.jsx("span",{className:"text-zinc-500 text-sm flex-shrink-0 w-5 text-right",children:p}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-sm font-medium truncate text-white group-hover:text-[var(--accent-color)] transition-colors",children:s}),e.jsxs("div",{className:"text-xs text-gray-400 flex items-center gap-1.5 min-w-0",children:[e.jsx("span",{className:"truncate",children:r?r.map((P,$)=>P.onClick?e.jsx("span",{className:"clickable-text",onMouseDown:D=>D.stopPropagation(),onClick:D=>{D.stopPropagation(),P.onClick(D)},children:P.text},$):e.jsx("span",{children:P.text},$)):d}),a&&e.jsx("span",{className:"flex-shrink-0",children:a})]})]})]}),!l&&v&&e.jsx("div",{onClick:P=>{P.stopPropagation(),v(P)},className:"flex-shrink-0 p-2 text-gray-400 hover:text-white cursor-pointer",children:e.jsx(st,{className:"w-4 h-4"})})]})}function Me(){return e.jsx("div",{className:"animate-pulse",children:[...Array(5)].map((s,d)=>e.jsxs("div",{className:"flex items-center gap-3 py-2.5",children:[e.jsx("div",{className:"w-12 h-12 rounded-sm bg-zinc-800"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"h-4 bg-zinc-800 rounded w-3/4 mb-1.5"}),e.jsx("div",{className:"h-3 bg-zinc-800 rounded w-1/2"})]})]},d))})}function gt(){const s=ne(),{playTrack:d}=de(),{feedTopSongs:r,feedLastUpdated:i,loading:m,setFeedTopSongs:x,setFeedLastUpdated:p,setLoading:f}=_(),{feedCountry:l,showTop10:o}=je(),{findSong:a}=ze(),[b,c]=n.useState(!1),[h,N]=n.useState("mobile"),[S,v]=n.useState(null),[F,M]=n.useState(null),[E,U]=n.useState(!1),[G,t]=n.useState(!1),[j,O]=n.useState(null),[L,P]=n.useState(null),[$,D]=n.useState(!1),[Z,Q]=n.useState("mobile"),[le,J]=n.useState(null),[ue,K]=n.useState(null),[ee,W]=n.useState(null),fe=n.useCallback(async(A=!1)=>{const H=Date.now();if(!(!A&&i&&H-i<Se)){f("feed",!0),t(!1);try{const C=await Ve(l,10);x(C),p(H)}catch(C){console.error("Failed to fetch top songs:",C),t(!0)}finally{f("feed",!1)}}},[l,i,x,p,f]);n.useEffect(()=>{if(o){const A=Date.now();(!i||A-i>=Se)&&fe(!0)}},[o,l]);const V=async(A,H,C)=>{if(H){const B=await T.getSongById(H.Id);B&&d(B)}else await te(A,C)},te=async(A,H)=>{const C=!window.matchMedia("(hover: hover) and (pointer: fine)").matches;N(C?"mobile":"desktop"),C||v({x:H.clientX,y:H.clientY}),O(A.name),P(A.id),U(!0),c(!0);try{const B=await De(A.url);if(B&&Object.keys(B.linksByPlatform).length>0)M(B);else{const u=we(A.artistName,A.name);M(u)}}catch{const B=we(A.artistName,A.name);M(B)}finally{U(!1)}};if(!o)return null;const se=r.length>0,ie=m.feed&&!se&&!G;return e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Top 10"}),ie?e.jsx(Me,{}):se?e.jsx("div",{className:"space-y-0",children:r.map((A,H)=>{var w,I;const C=a(A.name,A.artistName),B=C!==null,u=(I=(w=C==null?void 0:C.ArtistItems)==null?void 0:w[0])==null?void 0:I.Id,R=B&&u?[{text:A.artistName,onClick:()=>s(`/artist/${u}`)}]:void 0;return e.jsx(he,{rank:H+1,title:A.name,subtitle:A.artistName,subtitleParts:R,artworkUrl:B&&C.AlbumId?T.getAlbumArtUrl(C.AlbumId,96):Xe(A.artworkUrl100,96),isInLibrary:B,isMenuOpen:ee===A.id||L===A.id&&b,onClick:g=>V(A,C,g),onContextMenu:async g=>{if(g.preventDefault(),C){const q=await T.getSongById(C.Id);q&&(K(q),W(A.id),Q("desktop"),J({x:g.clientX,y:g.clientY}),D(!0))}},onLongPress:async()=>{if(C){const g=await T.getSongById(C.Id);g&&(K(g),W(A.id),Q("mobile"),J(null),D(!0))}},onExternalClick:g=>te(A,g)},A.id)})}):e.jsx("div",{className:"py-8 text-left text-gray-500 text-sm",children:"Could not load charts"}),e.jsx(Ue,{isOpen:b,onClose:()=>{c(!1),M(null),P(null)},odesliData:F,loading:E,title:j||void 0,mode:h,position:S||void 0}),e.jsx(ve,{item:ue,itemType:"song",isOpen:$,onClose:()=>{D(!1),K(null),W(null)},zIndex:99999,mode:Z,position:le||void 0})]})}function yt(){const s=ne(),{playTrack:d}=de(),{feedNewReleases:r,feedLastUpdated:i,loading:m,setFeedNewReleases:x,setFeedLastUpdated:p,setLoading:f}=_(),{showNewReleases:l,muspyRssUrl:o}=je(),{findAlbum:a,findSong:b,findArtistImageUrl:c}=ze(),[h,N]=n.useState(!1),[S,v]=n.useState("mobile"),[F,M]=n.useState(null),[E,U]=n.useState(null),[G,t]=n.useState(!1),[j,O]=n.useState(!1),[L,P]=n.useState(null),[$,D]=n.useState(null),[Z,Q]=n.useState(!1),[le,J]=n.useState("mobile"),[ue,K]=n.useState(null),[ee,W]=n.useState(null),[fe,V]=n.useState(null),te=n.useCallback(async(u=!1)=>{if(!o)return;const R=Date.now();if(!(!u&&i&&R-i<Se)){f("feed",!0),O(!1);try{const w=await Qe(o,10);x(w),p(R)}catch(w){console.error("Failed to fetch Muspy releases:",w),O(!0)}finally{f("feed",!1)}}},[o,i,x,p,f]);n.useEffect(()=>{if(l&&o){const u=Date.now();(!i||u-i>=Se)&&te(!0)}},[l,o]),n.useEffect(()=>{r.forEach(u=>{if(!u.id.startsWith("muspy-")){const R=new window.Image;R.src=Re(u.id,250)}})},[r]);const se=n.useRef(new Set);n.useEffect(()=>{const u=async()=>{const R=r.filter(w=>w.id.startsWith("muspy-")&&!se.current.has(w.id));if(R.length!==0)for(const w of R){se.current.add(w.id);try{console.log(`[FeedSection] Searching MB for: ${w.title} - ${w.artistName}`);const I=await qe(w.artistName,w.title);if(I){console.log(`[FeedSection] Found MBID for "${w.title}": ${I.id} (${I.type})`);const q=_.getState().feedNewReleases.map(re=>re.id===w.id?{...re,id:I.id,type:I.type}:re);x(q)}else console.log(`[FeedSection] No MBID found for "${w.title}"`)}catch(I){console.error(`[FeedSection] Failed to search MB for "${w.title}":`,I)}}};r.length>0&&u()},[r,x]);const pe=async(u,R,w)=>{if(R)if(R.type==="song"){const I=await T.getSongById(R.song.Id);I&&d(I)}else s(`/album/${R.albumId}`);else await ie(u,w)},ie=async(u,R)=>{const w=!window.matchMedia("(hover: hover) and (pointer: fine)").matches;v(w?"mobile":"desktop"),w||M({x:R.clientX,y:R.clientY}),P(u.title),D(u.id),t(!0),N(!0);const I=u.mbUrl&&!u.id.startsWith("muspy-");try{let g=null;if(I&&(g=await De(u.mbUrl)),g&&Object.keys(g.linksByPlatform).length>0)U(g);else{const q=we(u.artistName,u.title);U(q)}}catch{const g=we(u.artistName,u.title);U(g)}finally{t(!1)}};if(!l||!o)return null;const A=r.length>0,H=m.feed,C=!!o,B=H&&!A&&!j&&C;return e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"New Releases"}),B?e.jsx(Me,{}):A?e.jsx("div",{className:"space-y-0",children:r.map(u=>{const R=u.type==="Single",w=R?b(u.title,u.artistName):null,I=w?null:a(u.title,u.artistName),g=w?{type:"song",song:w}:I?{type:"album",albumId:I.albumId}:null,q=g!==null,xe=!u.id.startsWith("muspy-")?Re(u.id,250):null,ae=c(u.artistName),oe=ae?T.getArtistImageUrl(ae,96):null,y=(g==null?void 0:g.type)==="song"&&(w!=null&&w.AlbumId)?T.getAlbumArtUrl(w.AlbumId,96):(g==null?void 0:g.type)==="album"&&(I!=null&&I.albumId)?T.getAlbumArtUrl(I.albumId,96):null;let k,z,X;xe?(k=xe,z=y||void 0,X=oe||void 0):y?(k=y,z=oe||void 0):k=oe||"";const Pe=new Date(u.releaseDate),ge=!isNaN(Pe.getTime())?Pe.toLocaleDateString("en-US",{month:"short",day:"numeric"}):"",Be=ge?`${u.artistName} • ${ge}`:u.artistName,Ge=R?e.jsx(Je,{className:"w-3 h-3"}):e.jsx(Ce,{className:"w-3 h-3"}),He=q&&ae?[{text:u.artistName,onClick:()=>s(`/artist/${ae}`)},...ge?[{text:` • ${ge}`}]:[]]:void 0;return e.jsx(he,{title:u.title,subtitle:Be,subtitleParts:He,subtitleIcon:Ge,artworkUrl:k,fallbackArtworkUrl:z,secondFallbackUrl:X,isInLibrary:q,imageLoading:"eager",isMenuOpen:fe===u.id||$===u.id&&h,onClick:Y=>pe(u,g,Y),onContextMenu:async Y=>{if(Y.preventDefault(),(g==null?void 0:g.type)==="song"&&w){const me=await T.getSongById(w.Id);me&&(W(me),V(u.id),J("desktop"),K({x:Y.clientX,y:Y.clientY}),Q(!0))}else if((g==null?void 0:g.type)==="album"&&I){const me=await T.getAlbumById(I.albumId);me&&(W(me),V(u.id),J("desktop"),K({x:Y.clientX,y:Y.clientY}),Q(!0))}},onLongPress:async()=>{if((g==null?void 0:g.type)==="song"&&w){const Y=await T.getSongById(w.Id);Y&&(W(Y),V(u.id),J("mobile"),K(null),Q(!0))}else if((g==null?void 0:g.type)==="album"&&I){const Y=await T.getAlbumById(I.albumId);Y&&(W(Y),V(u.id),J("mobile"),K(null),Q(!0))}},onExternalClick:Y=>ie(u,Y)},u.id)})}):C?e.jsx("div",{className:"py-8 text-left text-gray-500 text-sm",children:j?"Failed to load releases":"No new releases found"}):e.jsx("div",{className:"py-8 text-center text-gray-500 text-sm",children:"Configure Muspy RSS in settings"}),e.jsx(Ue,{isOpen:h,onClose:()=>{N(!1),U(null),D(null)},odesliData:E,loading:G,title:L||void 0,mode:S,position:F||void 0}),e.jsx(ve,{item:ee,itemType:(ee==null?void 0:ee.Type)==="Audio"?"song":"album",isOpen:Z,onClose:()=>{Q(!1),W(null),V(null)},zIndex:99999,mode:le,position:ue||void 0})]})}function bt({twoColumns:s=!1}){const d=ne(),{recentlyPlayed:r,loading:i,setRecentlyPlayed:m,setLoading:x}=_(),{showRecentlyPlayed:p}=je(),{playTrack:f}=de(),l=We(),[o,a]=n.useState(!1),[b,c]=n.useState("mobile"),[h,N]=n.useState(null),[S,v]=n.useState(null);n.useEffect(()=>{p&&(async()=>{x("recentlyPlayed",!0);try{const j=await T.getRecentlyPlayed(10);m(j.Items||[])}catch(j){console.error(j)}finally{x("recentlyPlayed",!1)}})()},[p,m,x]);const F=t=>{f(t,r)},M=t=>{var P,$,D,Z;const j=[],O=t.AlbumArtist||(($=(P=t.ArtistItems)==null?void 0:P[0])==null?void 0:$.Name)||"Unknown Artist",L=(Z=(D=t.ArtistItems)==null?void 0:D[0])==null?void 0:Z.Id;return j.push({text:O,onClick:L?()=>d(`/artist/${L}`):void 0}),t.Album&&(j.push({text:" • "}),j.push({text:t.Album,onClick:t.AlbumId?()=>d(`/album/${t.AlbumId}`):void 0})),j};if(!p)return null;const E=r&&r.length>0,G=i.recentlyPlayed&&!E;return e.jsxs("div",{className:"mb-8",children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Recently Played"}),G?e.jsx(Me,{}):E?e.jsx("div",{className:s?"md:grid md:grid-cols-2 md:gap-3 min-[1680px]:block":"",children:s?e.jsxs(e.Fragment,{children:[e.jsx("div",{children:r.slice(0,5).map(t=>{var j,O;return e.jsx(he,{title:t.Name||"Unknown",subtitle:`${t.AlbumArtist||((O=(j=t.ArtistItems)==null?void 0:j[0])==null?void 0:O.Name)||"Unknown Artist"}${t.Album?` • ${t.Album}`:""}`,subtitleParts:M(t),artworkUrl:T.getAlbumArtUrl(t.AlbumId||t.Id,96),isCurrentTrack:(l==null?void 0:l.Id)===t.Id,isInLibrary:!0,isMenuOpen:(S==null?void 0:S.Id)===t.Id,paddingRight:!0,onClick:()=>F(t),onContextMenu:L=>{L.preventDefault(),v(t),c("desktop"),N({x:L.clientX,y:L.clientY}),a(!0)},onLongPress:()=>{v(t),c("mobile"),N(null),a(!0)}},t.Id)})}),e.jsx("div",{children:r.slice(5,10).map(t=>{var j,O;return e.jsx(he,{title:t.Name||"Unknown",subtitle:`${t.AlbumArtist||((O=(j=t.ArtistItems)==null?void 0:j[0])==null?void 0:O.Name)||"Unknown Artist"}${t.Album?` • ${t.Album}`:""}`,subtitleParts:M(t),artworkUrl:T.getAlbumArtUrl(t.AlbumId||t.Id,96),isCurrentTrack:(l==null?void 0:l.Id)===t.Id,isInLibrary:!0,isMenuOpen:(S==null?void 0:S.Id)===t.Id,paddingRight:!0,onClick:()=>F(t),onContextMenu:L=>{L.preventDefault(),v(t),c("desktop"),N({x:L.clientX,y:L.clientY}),a(!0)},onLongPress:()=>{v(t),c("mobile"),N(null),a(!0)}},t.Id)})})]}):r.map(t=>{var j,O;return e.jsx(he,{title:t.Name||"Unknown",subtitle:`${t.AlbumArtist||((O=(j=t.ArtistItems)==null?void 0:j[0])==null?void 0:O.Name)||"Unknown Artist"}${t.Album?` • ${t.Album}`:""}`,artworkUrl:T.getAlbumArtUrl(t.AlbumId||t.Id,96),isCurrentTrack:(l==null?void 0:l.Id)===t.Id,isInLibrary:!0,isMenuOpen:(S==null?void 0:S.Id)===t.Id,paddingRight:!0,onClick:()=>F(t),onContextMenu:L=>{L.preventDefault(),v(t),c("desktop"),N({x:L.clientX,y:L.clientY}),a(!0)},onLongPress:()=>{v(t),c("mobile"),N(null),a(!0)}},t.Id)})}):null,e.jsx(ve,{item:S,itemType:"song",isOpen:o,onClose:()=>{a(!1),v(null)},zIndex:99999,mode:b,position:h||void 0})]})}function Ct(){const[s,d]=n.useState(!1),{recentlyAdded:r,recentlyPlayed:i,loading:m}=_(),{showMoodCards:x,showTop10:p,showNewReleases:f,showRecentlyPlayed:l,muspyRssUrl:o}=je(),a=n.useRef(!1),{isQueueSidebarOpen:b}=de();n.useEffect(()=>{(m.recentlyAdded||m.recentlyPlayed)&&(a.current=!0)},[m.recentlyAdded,m.recentlyPlayed]);const h=[p,f&&!!o,l].filter(Boolean).length,N=a.current&&!m.recentlyAdded&&!m.recentlyPlayed&&r.length===0&&i.length===0;return e.jsxs("div",{className:"pb-4",children:[e.jsx("div",{className:`fixed top-0 left-0 right-0 bg-black z-10 lg:left-16 transition-[left,right] duration-300 ${b?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top))"},children:e.jsx("div",{className:"max-w-[768px] min-[1680px]:max-w-[1080px] w-full mx-auto",children:e.jsx(ot,{onSearchStateChange:d})})}),e.jsx("div",{className:`fixed left-0 right-0 z-[60] lg:left-16 transition-[left,right] duration-300 ${b?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top) + 4.5rem - 2px)",height:"24px",background:"linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent)"}}),e.jsx("div",{className:s?"hidden [@media((hover:hover)_and_(pointer:fine)_and_(min-width:1024px))]:block":"",style:{paddingTop:"calc(env(safe-area-inset-top) + 4.5rem + 24px)"},children:e.jsxs("div",{className:"w-full",children:[x&&e.jsx(ht,{}),e.jsx("div",{className:"mt-4 pb-4",children:e.jsx(pt,{})}),h>0&&e.jsxs("div",{className:`
              mt-4 px-4
              ${h>=2?"md:grid md:gap-3":""}
              ${h===2?"md:grid-cols-2":""}
              ${h>=3?"md:grid-cols-2 min-[1680px]:grid-cols-3":""}
            `,children:[l&&e.jsx("div",{className:h===3?"md:col-span-2 min-[1680px]:col-span-1":"",children:e.jsx(bt,{twoColumns:h===3})}),p&&e.jsx("div",{children:e.jsx(gt,{})}),f&&e.jsx("div",{children:e.jsx(yt,{})})]}),N&&e.jsx("div",{className:"flex items-center justify-center py-16 text-gray-400",children:e.jsx("p",{children:"No music found"})})]})})]})}export{Ct as default};
