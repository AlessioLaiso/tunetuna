import{b as ve,r as t,f as Be,j as n,D as Qe,I as Ve,e as q,C as Ce,u as v,a as F,d as $e,l as W,i as ze}from"./index-Di0xjSmi.js";import{P as Ue}from"./Pagination-BcdLLTPj.js";import{F as Se}from"./FilterBottomSheet-C0prlNNc.js";import{u as Xe,f as Je,a as Ke}from"./search-CG59b2Tx.js";import{A as We}from"./arrow-up-down-_pjW89sG.js";function qe({album:a,onContextMenu:C,contextMenuItemId:D,showImage:H=!0}){var c,P;const N=ve(),[I,E]=t.useState(!1),[Y,M]=t.useState("mobile"),[B,h]=t.useState(null),[b,f]=t.useState(!1),i=t.useRef(!1),r=D===a.Id,x=o=>{if(i.current){o.preventDefault(),i.current=!1;return}N(`/album/${a.Id}`)},Q=o=>{var w,k,A,T;o.preventDefault(),o.stopPropagation(),(k=(w=o.nativeEvent)==null?void 0:w.preventDefault)==null||k.call(w),(T=(A=o.nativeEvent)==null?void 0:A.stopImmediatePropagation)==null||T.call(A),i.current=!0,C?C(a,"album","desktop",{x:o.clientX,y:o.clientY}):(M("desktop"),h({x:o.clientX,y:o.clientY}),E(!0)),setTimeout(()=>{i.current=!1},300)},j=Be({onLongPress:o=>{o.preventDefault(),C?(i.current=!0,C(a,"album","mobile")):(i.current=!0,M("mobile"),h(null),E(!0))}});return n.jsxs(n.Fragment,{children:[n.jsxs("button",{onClick:o=>{if(I||i.current){o.preventDefault(),o.stopPropagation();return}x(o)},onContextMenu:o=>{Q(o)},...j,className:`text-left group ${r?"ring-2 ring-blue-500":""}`,children:[n.jsx("div",{className:"aspect-square rounded overflow-hidden mb-2 bg-zinc-900 relative flex items-center justify-center",children:b?n.jsx(Qe,{className:"w-12 h-12 text-gray-500"}):H?n.jsx(Ve,{src:q.getAlbumArtUrl(a.Id,474),alt:a.Name,className:"w-full h-full object-cover",showOutline:!0,rounded:"rounded",onError:()=>f(!0)}):n.jsx("div",{className:"w-full h-full bg-zinc-900"})}),n.jsx("div",{className:"text-sm font-medium text-white truncate",children:a.Name}),n.jsx("div",{className:"text-xs text-gray-400 truncate",children:a.AlbumArtist||((P=(c=a.ArtistItems)==null?void 0:c[0])==null?void 0:P.Name)||"Unknown Artist"})]}),n.jsx(Ce,{item:a,itemType:"album",isOpen:I,onClose:()=>E(!1),mode:Y,position:B||void 0})]})}const Ze=[{type:"albums"},{type:"artists",limit:5},{type:"playlists"},{type:"songs"}],G=84,ye=45,et=45,be=45,tt=45;function at(){const a=v(e=>e.albums),C=v(e=>e.setAlbums),D=v(e=>e.sortPreferences),H=v(e=>e.setSortPreference),N=v(e=>e.setLoading),I=v(e=>e.loading),E=v(e=>e.genres),Y=F(e=>e.playTrack),M=F(e=>e.playAlbum),B=F(e=>e.addToQueue),[h,b]=t.useState(""),[f,i]=t.useState(!1),[r,x]=t.useState(null),[Q,j]=t.useState(!1),c=t.useRef(null),[P,o]=t.useState(!1),[w,k]=t.useState("mobile"),[A,T]=t.useState(null),[L,Z]=t.useState(null),[we,ee]=t.useState(null),[O,te]=t.useState(0),[ne,se]=t.useState(0),[Ae,re]=t.useState(ye),V=ve(),[oe,le]=$e(),ae=t.useRef(null),ie=t.useRef(null),[S,ce]=t.useState([]),[u,$]=t.useState({min:null,max:null}),[ue,z]=t.useState(!1),[de,Ie]=t.useState(null),[Ee,fe]=t.useState([]),g=D.albums,R=t.useRef(!0),[je,me]=t.useState(!1),he=t.useRef(g),[Ne,ge]=t.useState(be),U=F(e=>e.isQueueSidebarOpen);t.useEffect(()=>{const e=oe.get("year");if(e){const s=parseInt(e,10);!isNaN(s)&&s>0&&($({min:s,max:s}),i(!0),le({},{replace:!0}))}},[oe,le]),t.useEffect(()=>{(async()=>{try{const s=v.getState();if(s.years.length>0)fe(s.years);else{const d=await q.getYears();fe(d)}}catch(s){W.error("Failed to load filter values:",s)}})()},[]);const pe=S.length>0||u.min!==null||u.max!==null;t.useEffect(()=>{c.current&&c.current.abort();const e=h.trim().length>0;if(e||pe){j(!0),c.current=new AbortController;const s=window.setTimeout(async()=>{var d,l,m,_;if(!((d=c.current)!=null&&d.signal.aborted))try{let y;e?y=await Xe(h,450):y=await Je(450),(l=c.current)!=null&&l.signal.aborted||x(y)}catch(y){(m=c.current)!=null&&m.signal.aborted||(W.error("Search failed:",y),x(null))}finally{(_=c.current)!=null&&_.signal.aborted||j(!1)}},250);return()=>{window.clearTimeout(s),c.current&&c.current.abort()}}else c.current=null,x(null),j(!1)},[h,pe]);const p=t.useMemo(()=>{if(!r)return null;const e=l=>{if(u.min!==null||u.max!==null)return!1;if(S.length>0){const m=l.Genres||[];if(!S.some(y=>m.some(K=>K.toLowerCase()===y.toLowerCase())))return!1}return!0},s=l=>{if(S.length>0){const m=l.Genres||[];if(!S.some(y=>m.some(K=>K.toLowerCase()===y.toLowerCase())))return!1}if(u.min!==null||u.max!==null){const m=l.ProductionYear;if(!m||m<=0||u.min!==null&&m<u.min||u.max!==null&&m>u.max)return!1}return!0},d=l=>!(u.min!==null||u.max!==null||S.length>0);return{albums:r.albums.filter(s),artists:r.artists.filter(e),playlists:(r.playlists||[]).filter(d),songs:r.songs.filter(s)}},[r,S,u]);t.useEffect(()=>{if(f){const s=window.matchMedia("(hover: hover) and (pointer: fine) and (min-width: 1024px)").matches?ie:ae;setTimeout(()=>{var d;if((d=s.current)==null||d.focus(),s.current){const l=s.current.value.length;s.current.setSelectionRange(l,l)}},50)}},[f]),t.useEffect(()=>{if(!f)return;const e=s=>{s.key==="Escape"&&(s.preventDefault(),s.stopPropagation(),xe())};return window.addEventListener("keydown",e,!0),()=>window.removeEventListener("keydown",e,!0)},[f]),t.useEffect(()=>()=>{c.current&&c.current.abort()},[]);const Me=e=>{b(e),e.trim().length>0&&!f&&i(!0)},Pe=()=>{b(""),x(null)},xe=()=>{i(!1),b(""),x(null),ce([]),$({min:null,max:null})},ke=e=>{Ie(e),z(!0)},Te=e=>{ce(e)},Le=e=>{$(e)},Oe=e=>{V(`/artist/${e}`),i(!1),b(""),x(null)},Re=e=>{V(`/album/${e}`),i(!1),b(""),x(null)},_e=e=>{Y(e,[e])},Fe=()=>{p!=null&&p.songs&&p.songs.length>0&&M(p.songs)},Ge=()=>{p!=null&&p.songs&&p.songs.length>0&&B(p.songs)},De=e=>{V(`/playlist/${e}`),i(!1),b(""),x(null)},He=(e,s,d="mobile",l)=>{Z(e),ee(s),k(d),T(l||null),o(!0)};t.useEffect(()=>{const e=s=>{};return document.addEventListener("contextmenu",e,!0),()=>{document.removeEventListener("contextmenu",e,!0)}},[]),t.useEffect(()=>{h.trim()||te(0)},[g,h]),t.useEffect(()=>{ge(be)},[h,f,r==null?void 0:r.songs.length]);const X=t.useCallback(()=>{var l;if(!f||!((l=r==null?void 0:r.songs)!=null&&l.length))return;const e=window.scrollY||document.documentElement.scrollTop,s=window.innerHeight||document.documentElement.clientHeight,d=document.documentElement.scrollHeight;e+s*1.5>=d&&ge(m=>Math.min(m+tt,r.songs.length))},[f,r==null?void 0:r.songs.length]);t.useEffect(()=>{var e;if(!(!f||!((e=r==null?void 0:r.songs)!=null&&e.length)))return window.addEventListener("scroll",X,{passive:!0}),()=>{window.removeEventListener("scroll",X)}},[X]),t.useEffect(()=>{re(ye)},[O,a.length]);const J=t.useCallback(()=>{const e=window.scrollY||document.documentElement.scrollTop,s=window.innerHeight||document.documentElement.clientHeight,d=document.documentElement.scrollHeight;e+s*1.5>=d&&re(l=>Math.min(l+et,a.length))},[a.length]);t.useEffect(()=>(window.addEventListener("scroll",J,{passive:!0}),()=>{window.removeEventListener("scroll",J)}),[J]),t.useEffect(()=>{h.trim()||(!R.current&&he.current!==g&&me(!0),he.current=g,Ye())},[O,g,h]),t.useEffect(()=>{R.current&&(R.current=!1)},[]);const Ye=async()=>{N("albums",!0);try{const e={limit:G,startIndex:O*G};g==="RecentlyAdded"?(e.sortBy=["DateCreated"],e.sortOrder="Descending"):g==="Newest"?(e.sortBy=["ProductionYear","SortName"],e.sortOrder=["Descending","Ascending"]):(e.sortBy=["SortName"],e.sortOrder="Ascending");const s=await q.getAlbums(e);C(s.Items),se(s.TotalRecordCount||0)}catch(e){W.error("Failed to load albums:",e),C([]),se(0)}finally{N("albums",!1),me(!1)}};return n.jsxs(n.Fragment,{children:[n.jsxs("div",{className:"pb-20",children:[n.jsx("div",{className:`fixed top-0 left-0 right-0 bg-black z-10 lg:left-16 transition-[left,right] duration-300 ${U?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top))"},children:n.jsx("div",{className:"max-w-[768px] mx-auto",children:n.jsxs("div",{className:"p-4",children:[n.jsxs("div",{className:"flex items-center justify-between mb-3",children:[n.jsx("h1",{className:"text-2xl font-bold text-white",children:"Albums"}),n.jsx("button",{onClick:()=>i(!0),className:"w-10 h-10 flex items-center justify-center text-white hover:bg-zinc-800 rounded-full transition-colors","aria-label":"Search",children:n.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})})]}),!f&&n.jsxs("div",{className:"flex items-center justify-between gap-2",children:[n.jsxs("button",{onClick:()=>{H("albums",g==="RecentlyAdded"?"Alphabetical":g==="Alphabetical"?"Newest":"RecentlyAdded")},className:"text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-1",children:[g==="RecentlyAdded"?"Recently Added":g==="Newest"?"Newest":"Alphabetically",n.jsx(We,{className:"w-4 h-4"})]}),I.albums&&!R.current&&n.jsx("div",{className:"flex items-center",children:n.jsx(ze,{})})]})]})})}),n.jsx("div",{className:`fixed left-0 right-0 z-10 lg:left-16 transition-[left,right] duration-300 ${U?"sidebar-open-right-offset":"xl:right-0"}`,style:{top:"calc(var(--header-offset, 0px) + env(safe-area-inset-top) + 7rem - 8px)",height:"24px",background:"linear-gradient(to bottom, rgba(0, 0, 0, 0.8), transparent)"}}),n.jsx("div",{style:{paddingTop:"calc(env(safe-area-inset-top) + 7rem)"},onContextMenu:e=>{},children:n.jsx("div",{className:`${je?"opacity-50 pointer-events-none":""} ${f?"hidden [@media((hover:hover)_and_(pointer:fine)_and_(min-width:1024px))]:block":""}`,onContextMenu:e=>{},children:a.length===0&&!I.albums?n.jsx("div",{className:"flex items-center justify-center py-16 text-gray-400",children:n.jsx("p",{children:"No albums found"})}):n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"p-4",children:n.jsx("div",{className:"grid grid-cols-3 md:grid-cols-4 gap-3",onContextMenu:e=>{},children:a.map((e,s)=>n.jsx(qe,{album:e,onContextMenu:He,contextMenuItemId:(L==null?void 0:L.Id)||null,showImage:s<Ae},e.Id))})}),n.jsx(Ue,{currentPage:O,totalPages:Math.ceil(ne/G),onPageChange:te,itemsPerPage:G,totalItems:ne})]})})})]}),n.jsx(Ke,{isOpen:f,onClose:xe,title:"Search",searchQuery:h,onSearchChange:Me,onClearSearch:Pe,isLoading:Q,results:p,sections:Ze,filterConfig:{showGenreFilter:!0,showYearFilter:!0},filterState:{selectedGenres:S,yearRange:u},onOpenFilterSheet:ke,onArtistClick:Oe,onAlbumClick:Re,onSongClick:_e,onPlaylistClick:De,onPlayAllSongs:Fe,onAddSongsToQueue:Ge,visibleSongImageCount:Ne,isQueueSidebarOpen:U,desktopSearchInputRef:ie,mobileSearchInputRef:ae}),de==="genre"&&n.jsx(Se,{isOpen:ue,onClose:()=>z(!1),filterType:"genre",genres:E,selectedValues:S,onApply:Te}),de==="year"&&n.jsx(Se,{isOpen:ue,onClose:()=>z(!1),filterType:"year",availableYears:Ee,yearRange:u,onApplyYear:Le}),n.jsx(Ce,{item:L,itemType:we,isOpen:P,onClose:()=>{o(!1),Z(null),ee(null)},zIndex:99999,mode:w,position:A||void 0})]})}export{at as default};
